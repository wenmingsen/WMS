<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=0">
    <title>收货信息</title>
    <link rel="stylesheet" type="text/css" href="css/weui.css" />
    <link rel="stylesheet" type="text/css" href="css/public.css" />
    <link rel="stylesheet" type="text/css" href="css/mall.css" />
</head>
<body style="background:#f6f6f6;" >
    <div class="container">
        <div class="head">
            <div class="head_navbar" style = "background-color: #184f84;color:white">
                <div class="head_navbar_left">
                    <a href="javascript:;" class="w-h-35" onClick="javascript :history.back(-1);"><i class="back_before"></i></a>
                </div>
                <div class="head_navbar_item">收货信息</div>
            </div>
            <div class="head_navbar_r save">
              
            </div>
        </div>
        <div class="rec_info" style="border-top:0;">
            <div class="weui-cells weui-cells_form">
                <div class="weui-cell pad_15">
                    <div class="weui-cell__hd"><label class="weui-label">收货人：</label></div>
                    <div class="weui-cell__bd">
                        <input class="weui-input" type="text" placeholder="" id = "name">
                    </div>
                </div>
                <div class="weui-cell pad_15">
                    <div class="weui-cell__hd"><label class="weui-label">联系电话 :</label></div>
                    <div class="weui-cell__bd">
                        <input class="weui-input" type="number" id = "phone">
                    </div>
                </div>
                 <div class="weui-cell pad_15">
                 	<div id = "position" class = "position" style="width: 100%;">
							<div><span style="width: 100%;">省份: <select id = "province" name = "province" onchange = "selectProvince()" style="margin-left: 7.6%;width: 75%;"></select></span></div>
	                		<div><span style="width: 100%;">城市: <select id = "city" name = "city" onchange = "selectCity()" style="margin-left: 7.6%;width: 75%;"></select></span></div>
	                		<div><span style="width: 100%;">县(区): <select id = town name = "town"  style="margin-left: 4.2%;width: 75%;"></select></span></div>
					</div> 
				</div>
                <div class="weui-cell pad_15">
                    <div class="weui-cell__hd"><label class="weui-label">收货地址 :</label></div>
                    <div class="weui-cell__bd">
                        <input class="weui-input" type="text" id = "address_other">
                    </div>
                </div>
            </div>
        </div>
        <div>
        	<input type = "button" onclick = "submitPosition()" value = "保存" style = "margin: 5px; border: 1px solid; margin-left: 10%; padding: 2% 35%; color:white;background-color: #184f84;">
        </div>
       
    </div>
     <script type="text/javascript" src="js/jquery.min.js"></script>
     <script type="text/javascript" src="common/common.js"></script>
    <script type="text/javascript">
    /***************初始化修改地址 **************************/
  	var orderId = null;
  	var addressLevel1Id = null;
  	var addressLevel2Id = null;
  	var addressLevel3Id = null;
    $(function(){
	    	//清楚已存地址信息  
	    	$("#name").val();
	    	$("#phone").val();
	    	$("#address_other").val();
    	 var str = location.search;
  	 	 var idAll = str.split('=')[1];
 		 queryAdministrativeRgion(null,null);
  	 	 if(str.search("orderId")==-1){
  	 		 //修改地址 
	  	 	 var id = idAll.split("&")[0];
	 		 addressLevel1Id = idAll.split("&")[1];
	 		 addressLevel2Id = idAll.split("&")[2];
	 		 addressLevel3Id = idAll.split("&")[3];
	 		 orderId = idAll.split("&")[4];
  	 		 queryAddress(id);
  	 		 queryAdministrativeRgion(addressLevel1Id,addressLevel2Id);
  	 	 }else{
  	 		 //新增地址 
  	 		 orderId = idAll;
  	 	 }
    });
	
    
    /********查询城市  **************/
    function queryAdministrativeRgion(addressLevel1Id,addressLevel2Id){
    	var url = "/"+getRoot()+"/ins/DAR/queryPCT";
    	var params = {};
    	if(addressLevel1Id){
	    	params.addressLevel1Id = addressLevel1Id;
    	}
    	if(addressLevel2Id){
	    	params.addressLevel2Id = addressLevel2Id;
    	}
    	$.ajax({
	         type: "post",
	         url: url,
	         data: params,
	         success: function(result){
				 if(result.state == 0){
					setAdministrativeRegion(result.data);
				 }
	         }
	     });
    }
    
    
    /*******设置的城市***************/
    function setAdministrativeRegion(result){
    	if(result[0]){
    		var province = result[0];
    		var provinceP = $("#province");
    		provinceP.empty();
    		for(var i = 0 ;i <province.length; i++){
    			provinceP.append("<option name = 'province' value = '"+province[i].administrativeRegionId+"'>"+province[i].administrativeRegionName+"</option>");
    		}
   			queryAdministrativeRgion($("#province").val(),null);
    		return ;
    	}
    	if(result[1]){
    		var city = result[1];
    		var cityC = $("#city");
    		cityC.empty();
    		for(var i = 0 ;i <city.length; i++){
    			cityC.append("<option name = 'city'  value = '"+city[i].administrativeRegionId+"'>"+city[i].administrativeRegionName+"</option>");
    		}
   			queryAdministrativeRgion(null,$("#city").val());
    		return ;
    	}
    	if(result[2]){
    		var town = result[2];
    		var townT = $("#town");
    		townT.empty();
    		for(var i = 0 ;i <town.length; i++){
    			townT.append("<option name = 'town' value = '"+town[i].administrativeRegionId+"'>"+town[i].administrativeRegionName+"</option>");
    		}
    	}
    }
    
    /*******省份改变 ******************/
    function selectProvince(){
    	addressLevel1Id = $("#province").val();
    	queryAdministrativeRgion(addressLevel1Id,null);
    }
    
    /************城市改变 ****************/
    function selectCity(){
    	addressLevel2Id = $("#city").val();
    	queryAdministrativeRgion(null,addressLevel2Id);
    }
    
    /*****查询要修改的地址 **********/
    function queryAddress(id){
    	var url = "/"+getRoot()+"/ins/drtShopAddress/queryAddressList";
    	var params = {};
    	params.id = id;
    	params.addressLevel1Id = addressLevel1Id;
    	params.addressLevel2Id = addressLevel2Id;
    	$.ajax({
	         type: "post",
	         url: url,
	         data: params,
	         success: function(result){
				 if(result.state == 0){
					 setPositionInfo(result.data);
				 }
	         }
	     });
    }
    function setPositionInfo(result){
    	if(!result[0]){
    		return;
    	}
    	$("#name").val(result[0].name);
    	$("#phone").val(result[0].phone);
    	selectProvince();
    	$("#province").val(result[0].addressLevel1Id);
    	selectCity();
    	$("#city").val(result[0].addressLevel2Id);
    	$("#town").val(result[0].addressLevel3Id);
    	$("#address_other").val(result[0].addressOther);
    	$(".container").data("id",result[0].id);
    }
    /************保存地址 *************************/
    function submitPosition(){
    	var url = "/"+getRoot()+"/ins/drtShopAddress/updateAddress";
		var params = {};
		params.id = $(".container").data("id");
 		params.name = $("#name").val();
 		params.phone = $("#phone").val();
 		params.addressLevel1Id = $("#province").val();
 		$("select option[name = 'province']").each(function(){
 			if($(this).is(":checked")){
 				params.addressLevel1 = $(this).text();
 			}
 		});
 		params.addressLevel2Id = $("#city").val();
 		$("select option[name = 'city']").each(function(){
 			if($(this).is(":checked")){
 				params.addressLevel2 = $(this).text();
 			}
 		});
 		params.addressLevel3Id = $("#town").val();
 		$("select option[name = 'town']").each(function(){
 			if($(this).is(":checked")){
 				params.addressLevel3 = $(this).text();
 			}
 		})
 		params.addressOther = $("#address_other").val();
 		 $.ajax({
 	         type: "post",
 	         url: url,
 	         data: params,
 	         success: function(result){
 				 showMessage(result.message);
 				 if(result.state == 0){
 					backOrderDetail();
				 }
 	         }
 	     });
    }
    
    /**************返回订单页面 **********/
    function backOrderDetail(){
  	        return location.href="orderGoods/order_detail.html?orderId="+orderId+"&orderState";
    }
    
    
    function showMessage(data){
   	  $("#message").html(data).hide(3000);
    }
    
    </script>
    
    <div >
    	<div id = "message" style = "text-align:center ">
    		
    	</div>
    </div>
</body>
</html>