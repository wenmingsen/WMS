<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=0">
    <title>我的订单</title>
    <link rel="stylesheet" type="text/css" href="css/weui.css" />
    <link rel="stylesheet" type="text/css" href="css/public.css" />
    <link rel="stylesheet" type="text/css" href="css/mall.css" />
</head>
<body style="background:#f6f6f6;">
    <div class="container">
        <div class="head">
            <div class="head_navbar">
                <div class="head_navbar_left">
                    <a class="w-h-35" href="javascript:;" onClick="javascript :history.back(-1);"><i class="back_before"></i></a>
                </div>
                <div class="head_navbar_item">我的订单</div>
            </div>
        </div>
        <div class="weui-navbar">
            <div class="weui-navbar__item weui-navbar__item_on" onclick="stateClick(0)">
                全部订单
            </div>
            <div class="weui-navbar__item" onclick="stateClick(1)">
                待付款
            </div>
            <div class="weui-navbar__item" onclick="stateClick(2)">
                待收货
            </div>
            <div class="weui-navbar__item" onclick="stateClick(3)">
                已完成
            </div>
        </div><div style="height:50px;"></div>
        <div id="shoporder">
        
        </div>
        
        <div style="height:80px;"></div>
    </div>
    <script type="text/javascript" src="js/jquery.min.js"></script>
    <script type="text/javascript" src="common/common.js"></script>
    <script type="text/javascript">
        $(function(){
            $('.weui-navbar__item').on('click', function () {
                $(this).addClass('weui-navbar__item_on').siblings().removeClass('weui-navbar__item_on');
            });
            queryShopOrder(0);
        });
        
        //获取用户所有订单
        function queryShopOrder(state){
        	var data={};
        	data.state=state;
        	var ctx="/"+getRoot();
        	$.ajax({
				url : ctx+'/ins/drtShopOrder/selShopOrder',
				// data: {userId:selectContent[0].userId},
				data : data,
				type : "POST",
				//traditional : true,
				success : function(result) {
					if(result!=null){
						if(result.shopOrders!=null){
							if(result.shopOrders.length==0){
								return;
							}
							for(var i=0;i<result.shopOrders.length;i++){
								var stateHtml='';
								if(result.shopOrders[i].orderState==1){
									stateHtml='<input type="button" value="付款"  class="pay" onclick="fk('+result.shopOrders[i].id+','+1+')"/>'+
					                '<input type="button" value="取消订单"  class="confirm" onclick="qrsh('+result.shopOrders[i].id+','+5+')"/>';
								}else if(result.shopOrders[i].orderState==2){
									stateHtml='<p class="sent">已发货</p>'+
					                '<input type="button" value="确认收货"  class="confirm" onclick="qrsh('+result.shopOrders[i].id+','+4+')"/>';
								}else if(result.shopOrders[i].orderState==3){
									stateHtml='<p class="wait_sent">待发货</p>';
								}else if(result.shopOrders[i].orderState==4){
									stateHtml= '<p class="complate">已完成</p>';
								}else{
									stateHtml= '<p class="complate">已取消</p>';

								}
								var orderHtml='<div class="order_state_wrap">'+
						            '<div class="order_state" id="'+i+'">'+
						               ' <p class="order_num">订单号：'+result.shopOrders[i].orderNo+'</p>'+stateHtml+
						            '</div>'
					           
								var orderSons=result.details;
								for(var j=0;j<orderSons.length;j++){
									var  html='';
									if(result.shopOrders[i].orderNo==orderSons[j].orderId){
										html='<div class="shop_goods_item clear">'+
						                '<div class="detail clear">'+
						                    '<a href="goods_detail.html" class="detail_mask"></a>'+
						                   ' <div class="goods_pic">'+
						                        '<img src="'+orderSons[j].drtShopItem.itemPicture+'" width="100%" alt="" />'+
						                   ' </div>'+
						                   ' <div class="goods_con">'+
						                       ' <p class="tit order_title">'+orderSons[j].drtShopItem.itemName+'</p>'+
						                       ' <div class="price clear">'+
						                           ' <p class="rmb"><span class="num">积分</span>'+orderSons[j].drtShopItem.itemEarnings+'</p>'+
						                        '</div>'+
						                   ' </div>'+
						                '</div>'+
						               ' <div class="buy_num">x'+orderSons[j].itemNum+'</div>'+
						            '</div>'
						               orderHtml=orderHtml+html;
									}
						             
								}
								orderHtml=orderHtml+ '</div>'
								 $("#shoporder").append(orderHtml);
				        	}
						}
					}
				}
			});
        }
        
        
        //根据状态获取订单
        function stateClick(state){
        	$("#shoporder").html("");
        	queryShopOrder(state);
        }
       
        
        //确认收货/取消订单
        function qrsh(id,orderState){
         	var data={};
        	data.id=id;
        	data.orderState=orderState;
        	var ctx="http://localhost:8090/drtShop"
        	$.ajax({
				url : ctx+'/ins/drtShopOrder/updShopOrder',
				// data: {userId:selectContent[0].userId},
				data : data,
				type : "POST",
				//traditional : true,
				success : function(result) {
		            queryShopOrder(0);
					}
				});
        }
        
        //付款
        function fk(id,orderState){
        	location.href("orderGoods/order_detail.html?id="+id+"&orderState="+orderState);
        }
        
    </script>
</body>
</html>