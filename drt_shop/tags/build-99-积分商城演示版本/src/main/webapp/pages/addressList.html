<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=0">
   
    <title>收货信息</title>
    <link rel="stylesheet" type="text/css" href="../css/weui.css" />
    <link rel="stylesheet" type="text/css" href="../css/public.css" />
    <link rel="stylesheet" type="text/css" href="../css/mall.css" />
    <link rel="stylesheet" type="text/css" href="../css/bootstrap.min.css" />
    <style>
   	 .container {
	    padding-right: 0;
	    padding-left: 0;
	    margin-right: auto; 
	    margin-left: auto;
	}
    </style>
</head>
<body style="background:#f6f6f6;">
    <div class="container">
        <div class="head">
            <div class="head_navbar" style = "background-color: #184f84;color:white">
                <div class="head_navbar_left" id = "backHistory">
                    <a href="javascript:history.go(-1);" class="w-h-35" ><i class="back_before"></i></a>
                </div>
                <div class="head_navbar_item"><span style = "text-align:center;margin-left:30%;">地址列表</span>
                	<input type = "button" value = "新增地址" onclick = "addAddress()" style = "background-color: #184f84;color:white;margin-left:20%">
                </div>
                
            </div>
            <div class="head_navbar_r save">
              
            </div>
        </div>
        <div class="rec_info" style="border-top:0;">
            <div class="weui-cells weui-cells_form" id = "addressList">
                <!-- <div class="weui-cell pad_15">
                    <div class="weui-cell__bd">
                    	<div id = "detailAddress" >
                    		收件地址：**********
                    	</div>
                    	<div class = "changeAddressStatus">
                    		<span ><input type = "checkBox" id = "defaultAddress">设置为默认</span>
                    		<input type = "button" value = "修改" id = "updateAddress()" style = "margin-left: 50%;border:1px solid;right:5px;background-color: #ff5001;color:white;padding:2px">
                    		<input type = "button" value = "删除" id = "deleteAddress()" style = "border:1px solid;right:5px;background-color: #ff5001;color:white;padding:2px">
                    	</div>
                    </div>
                </div> -->
                
            <!--     <div class="weui-cell pad_15">
                    <div class="weui-cell__hd"><label class="weui-label">联系电话 :</label></div>
                    <div class="weui-cell__bd">
                        <input class="weui-input" type="number" id = "phone">
                    </div>
                </div>
                 <div class="weui-cell pad_15">
                 	<div id = "position">
							省份:<select id = "province" name = "province" onchange = "select()" style = "width:90px"></select>
	                		城市:<select id = "city" name = "city" onchange = "select()" style = "width:90px"></select>
					</div> 
				</div>
                <div class="weui-cell pad_15">
                    <div class="weui-cell__hd"><label class="weui-label">收货地址 :</label></div>
                    <div class="weui-cell__bd">
                        <input class="weui-input" type="text" id = "address_other">
                    </div>
                </div> -->
            </div>
        </div>
    </div>
     <script type="text/javascript" src="../js/jquery.min.js"></script>
     <script type="text/javascript" src="../js/bootstrap.min.js"></script>
     <script type="text/javascript" src="../common/common.js"></script>
    <script type="text/javascript">
    
    
    
    	var orderId = null;
    	var strOrderId = null;
    	$(function(){
    		 strOrderId = location.search;
    		 queryAddressList();
    		$(".container").on("click",".updateAddress",updateAddress).on("click",".deleteAddress",deleteAddress).on("click",".defaultAddress",defaultAddress);
   			if(strOrderId.search("orderId")==-1&&strOrderId.search("backHistory")!=-1){
    			var backHistory = $("#backHistory");
    			backHistory.empty();
    			backHistory.append('<a href="javascript:history.go(-3);" class="w-h-35" ><i class="back_before"></i></a>');		
   			}
    		
    	});
    	
    	/******查询所有地址 ********/
    	function queryAddressList(){
    		var url = getRootPath()+"/ins/drtShopAddress/queryAddressList";
    		var params = {};
    		$.ajax({
    	         type: "post",
    	         data:params,
    	         url: url,
    	         success: function(result){
    				 if(result.state == 0){
    					 showAllAddresses(result.data);
	   				 }
    	         }
    	     });    		
    	}
    	
    	
    	setTimeout(function(){
    		queryAddressList();
    	},50);
    	var addressSize = 0;
    	/*******展示所有地址 ********/
    	function showAllAddresses(result){
    		if(result.length!=addressSize){
    			addressSize=result.length;
    		}else{
    			return;
    		}
    		var addressList = $("#addressList");
    		addressList.empty();
    		for(var i = 0; i < result.length; i++){
    			var panel = '<div class="weui-cell pad_15" style = "border-bottom: 5px solid #dadada;">'+
			                    '<div class="weui-cell__bd">'+
					            '		<div id = "getAllInfo" style = "display:none" >'+result[i].name+','+result[i].phone+','+result[i].addressLevel1+result[i].addressLevel2+result[i].addressLevel3+result[i].addressOther+','+result[i].addressId+'</div>'+
					            '	<div id = "detailAddress" onclick = "ensureAddress(this)" width = "100%">'+
					            '<div><span>'+result[i].name+'</span><span style = "float:right">'+result[i].phone+'</span></div>'+
					            ' 		<span style = "font-size:14px;">'+result[i].addressLevel1+result[i].addressLevel2+result[i].addressLevel3+result[i].addressOther +'</span>'+
					            '	</div>'+
					            '	<div style = "margin-top: 10px;padding: 10px 0 0 0; border-top: 1px solid #dadada;" class = "changeAddressStatus" >'+
					            '		<span style = "float: left;font-size:15px;"><input type = "checkbox"   name ="radio" class = "defaultAddress"  value = "'+result[i].addressId+'">默认地址</span>'+
					            '<div style = "float: right;">'+
					            '		<a href="#"><span style = "font-size:14px" class="glyphicon glyphicon-pencil"></a><input type = "button" value = "编辑" class = "updateAddress" style = "border:0px solid;right:5px;background-color: white;padding:2px;font-size:15px">'+
					            '		<input type="text" value = "'+result[i].addressId+'&'+result[i].addressLevel1Id+'&'+result[i].addressLevel2Id+'&'+result[i].addressLevel3Id+'" style = "display:none">'+
					            '		<a href="#"><span style = "font-size:14px" class="glyphicon glyphicon-trash"></span></a><input type = "button" value = "删除" onclick = "deleteAddress(&#39;'+result[i].addressId+'&#39;)" style = "border:0px solid;right:5px;background-color: white;padding:2px;font-size:15px">'+
					            '</div>'+
					            '	</div>'+
					            '</div>'+
					        '</div>';
				if(result[i].isDefault==0){
					panel = '<div class="weui-cell pad_15" style = "border-bottom: 5px solid #dadada;">'+
			                    '<div class="weui-cell__bd">'+
					            '		<div id = "getAllInfo" style = "display:none" >'+result[i].name+','+result[i].phone+','+result[i].addressLevel1+result[i].addressLevel2+result[i].addressLevel3+result[i].addressOther+','+result[i].addressId+'</div>'+
					            '	<div id = "detailAddress" onclick = "ensureAddress(this)">'+
					            '<div><span>'+result[i].name+'</span><span style = "float:right">'+result[i].phone+'</span></div>'+
					            ' 	<span style = "font-size:14px">'+result[i].addressLevel1+result[i].addressLevel2+result[i].addressLevel3+result[i].addressOther +'</span>'+
					            '	</div>'+
					            '	<div style = "margin-top: 10px;padding: 10px 0 0 0;border-top: 1px solid #dadada;" class = "changeAddressStatus" >'+
					            '		<span  style = "float: left;font-size:15px;color:#ff5000"><input type = "checkbox"   checked name ="radio" class = "defaultAddress"  value = "'+result[i].addressId+'">默认地址</span>'+
					            '<div style = "float: right;">'+
					            '	<a href="#"><span style = "font-size:14px" class="glyphicon glyphicon-pencil"></a><input type = "button" value = "编辑" class = "updateAddress" style = "border:0px solid;right:5px;background-color: white;padding:2px;font-size:15px">'+
					            '		<input type="text" value = "'+result[i].addressId+'&'+result[i].addressLevel1Id+'&'+result[i].addressLevel2Id+'&'+result[i].addressLevel3Id+'" style = "display:none">'+
					            '	<a href="#" ><span style = "font-size:14px" class="glyphicon glyphicon-trash"></span></a><input type = "button" value = "删除" onclick = "deleteAddress(&#39;'+result[i].addressId+'&#39;)" style = "border:0px solid;right:5px;background-color: white;padding:2px;font-size:15px">'+
					            '</div>'+
					            '	</div>'+
					            '</div>'+
					        '</div>';
				}		        
				addressList.append(panel);
    		}
    	}
    	
    	/*****新增地址 ***********/
    	function addAddress(){
    		return location.href="address.html?orderId="+orderId+strOrderId;
    	}
    	
    	/*****判断从何处来的申请  ******/
    	function ensureAddress(btn){
    		var addressInfo = btn.previousElementSibling.innerHTML;
    		var name = addressInfo.split(",")[0];
    		var phone = addressInfo.split(",")[1];
    		var addressOther = addressInfo.split(",")[2];
    		var addressId = addressInfo.split(",")[3];
    		if(strOrderId.search("orderId")!=-1){
    			orderId = strOrderId.split('=')[1].split("&")[0];
    			if(orderId){//来自已有订单的地址修改 
    				updateOrderAddress(name,phone,addressOther,orderId,addressId);
    			 return;
    			}
    			/*****未提交订单的地址修改 ******/
    			var id = strOrderId.split("=")[2];
    			return location.href = "orderGoods/show_order.html?id ="+id+"&orderId="+addressId;
    		}else{//地址管理处的地址修改 
    			return;
    		}
    	}
    	
    	/*****updateOrderAddress******/
    	function updateOrderAddress(name,phone,addressOther,addressId){
    		var params = {};
    		params.addressId = addressId;
    		params.id = orderId;
    		params.name = name;
    		params.phone = phone;
    		params.address = addressOther;
    		var url = getRootPath()+"/ins/drtShopOrderDetail/updateOrderAddress";
    		$.ajax({
    	         type: "post",
    	         url: url,
    	         data: params,
    	         success: function(result){
    	        	 if(result.state == -1){
    	        		 Toast(result.message,2000);
    	        		 return;
    	        	 }
    	        	 location.href="orderGoods/order_detail.html?orderId="+orderId+"&orderState=1";
    	         }
    	     }); 
    	}
    	
    	/********修改地址 ***************/
    	function updateAddress(){
    		var idAll = $(this).next().val()+"&"+orderId;//idAll是地址主键id和一级二级城市的id组合  
    		return location.href="address.html?idAll="+idAll+strOrderId;
    	}
    	
    	/************设置默认地址 *****************/
    	function defaultAddress(){
    		var url = getRootPath()+"/ins/drtShopAddress/updateAddress";
    		var params = {};
    		var id = $(this).val();
    		params.addressId = id;
    		if($(this).is(":checked")){
    			params.isDefault = 0;
    		}else{
    			params.isDefault = 1;
    		}
    		var btn = $(this);
    		var allName = document.getElementsByName("radio");
    		for(var i = 0; i <allName.length; i++){
    			allName[i].checked=false;
    			allName[i].parentNode.style.color = 'black';
    		}
    		if(params.isDefault==0){
	    		btn.prop("checked",true);
	    		btn.parent().css({color:'#ff5000'});
    		}
    		 $.ajax({
     	         type: "post",
     	         url: url,
     	         data: params,
     	         success: function(result){
     	        	if(result.state==0){
	    	        	 if(params.isDefault==0){
	    	        		 Toast("设置成功",2000);
	    	        	 }else{
	    	        		 Toast("取消成功",2000);
	    	        	 }
   	        	 	}else{
	   	        	 	if(params.isDefault==0){
		   	        		 Toast("设置失败",2000);
		   	        	 }else{
		   	        		 Toast("取消失败",2000);
		   	        	 }
   	        	 	}
     	         }
     	     });
    	}
    	/********删除地址 ****************/
    	function deleteAddress(addressId){
    		var params = {};
    		params.addressId = addressId;
    		var url = getRootPath()+"/ins/drtShopAddress/deleteAddress";
    		$.ajax({
    	         type: "post",
    	         url: url,
    	         data: params,
    	         success: function(result){
    	        	 if(result.message){
	    	        	 Toast(result.message,2000);
    	        	 }
					if(result.state==0){
						queryAddressList();
					}	
    	         }
    	     }); 
    	}
    	/********返回订单 ***********/
    	/*  function backOrderDetail(){
    	  	     return location.href="orderGoods/order_detail.html?orderId="+orderId+"&orderState";
    	    } */
    	
    </script>
</body>
</html>