<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<title>商城</title>
		<meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">
		<link rel="shortcut icon" href="../../css/img/favicon.ico" type="image/x-icon">
		<link rel="stylesheet" href="../../css/mui/mui.min.css">
		<link rel="stylesheet" href="../../css/mui/mui.indexedlist.css">
		<link rel="stylesheet" type="text/css" href="../../css/mui/icons-extra.css" />
		<style>
			html,
			body {
				background-color: #efeff4;
			}
			.mui-bar{background-color: #184f84;}
			.mui-bar .mui-title{color:#f4f4f4;}
		    .mui-bar .mui-icon{color:#f4f4f4;}
		    
		    .mui-table-view{background: #efeff4;}
		    
			.mui-table-view.mui-grid-view .mui-table-view-cell .mui-media-body{
				font-size: 13px;
				margin-top:8px;
				color: #999;
				padding-right: 2px;
			}
			.goods-n{
			    font-size: 14px;
			    color: #333;
			    text-overflow: ellipsis;
		        white-space: normal;
		        overflow: hidden;
			    display: -webkit-box;
			    -webkit-box-orient: vertical;
			    -webkit-line-clamp: 2;
			    margin: 0 auto;
			    height: 44px;
			    line-height: 22px;
			    /* padding: 0 5px 0 5px; */
			}
			.goods-p{
				margin-left: 2px;
    			font-size: 18px;
    			color: #F40;
			}
			.mui-bar .mui-icon{font-size:26px;}
			
			.mui-bar-nav~.mui-content .mui-pull-top-pocket{top:116px;}
			.mui-slider {z-index: 5;background: #f7f5f5;border-bottom: 1px solid #e3e3e3;}
			.mui-segmented-control.mui-segmented-control-inverted .mui-control-item{color:#777;}
			.mui-table-view.mui-grid-view{padding: 0;}
			.mui-table-view.mui-grid-view .mui-table-view-cell{margin-right: 0px;padding-bottom: 4px;}
			.mui-table-view.mui-grid-view .mui-table-view-cell:nth-of-type(odd){padding-right: 4px;}
			.mui-table-view.mui-grid-view .mui-table-view-cell:nth-child(even)>a:not(.mui-btn){padding-right: 4px}
			.mui-table-view.mui-grid-view .mui-table-view-cell>a:not(.mui-btn){margin: -10px 0px 0px -20px;background: #fff;}
			
			.mui-search .mui-placeholder{font-size:15px;}
		</style>
	</head>

	<body>
		<header class="mui-bar mui-bar-nav">
			<!-- <a href="../mall_index.html" class="mui-icon mui-icon-left-nav mui-pull-left"></a> -->
		    <h1 class="mui-title">商城</h1>
		    <a href="me.html"><span class="mui-icon mui-icon-contact mui-pull-right"></span></a>
		    <a href="shop_cart.html"><span class="mui-icon mui-icon-extra mui-icon-extra-cart mui-pull-right" style="margin-right:4px;"></span></a>
		</header>
		<div class="mui-content">
			<div class="mui-indexed-list-search mui-input-row mui-search" onclick="clickSearch()">
				<input type="search" id="searchInput" class="mui-input-clear mui-indexed-list-search-input ui-pull-right" placeholder="搜索" onkeyup="enterSearch(event)">
			</div>
			<div id="slider" class="mui-slider">
				<div id="sliderSegmentedControl" class="mui-slider-indicator mui-segmented-control mui-segmented-control-inverted">
					<a class="mui-control-item mui-active" href="javascript:;">
						综合排序
					</a>
					<a class="mui-control-item" href="javascript:;">
						销量优先
					</a>
					<a class="mui-control-item" href="javascript:;">
						积分
					</a>
				</div>
			</div>
		</div>
		<div id="pullrefresh" class="mui-content mui-scroll-wrapper" style="padding-top:116px;">
			<div class="mui-scroll">
				<ul class="mui-table-view mui-grid-view">
				</ul>
			</div>
		</div>
		<script src="../../js/mui/mui.min.js"></script>
		<script src="../../js/mui/mui.pullToRefresh.js"></script>
		<script src="../../js/mui/mui.pullToRefresh.material.js"></script>
		<script type="text/javascript" src="../../js/jquery.min.js"></script>
		<script type="text/javascript" src="../../js/layer/layer.js"></script>
		<script type="text/javascript" src="../../common/common.js"></script>
		<script>
			mui.init({
				swipeBack: false,
				pullRefresh: {
					container: '#pullrefresh',
					down: {
						style:'circle',
						auto: true,//可选,默认false.首次加载自动上拉刷新一次
						callback: pulldownRefresh
					},
					up: {
						contentrefresh: '正在加载...',
						callback: pullupRefresh
					}
				}
			});
			
			
			var pageNumber = 1;
			var pageSize = 12;
			// 0-综合排序  1-销量优先  2-积分
			var sortType = 0;
			// 关键字
			var keyword = "";
			/**
			 * 下拉刷新具体业务实现
			 */
			function pulldownRefresh() {
				if(pageNumber == 1){
					$.post(getRootPath() + "/ins/mall/item/items", {pageNumber:1, pageSize:pageSize, sortType:sortType, keyword:keyword}, function(result){
						if(result.state == 0){
							var table = document.body.querySelector('.mui-table-view');
							table.innerHTML = "";
							if(result.data && result.data.length > 0){
								var items = result.data;
								for(var i = 0, len = items.length; i < len; i++) {
									var li = document.createElement('li');
									li.setAttribute("itemId", items[i].itemId);
									li.className = 'mui-table-view-cell mui-media mui-col-xs-6';
									li.innerHTML = '<a href="goods_detail.html?id=' + items[i].itemId + '">'
													+ '<img class="mui-media-object" src="' + items[i].imgUrl + '" style="height: 9rem;">'
										            + '<div class="goods-n mui-text-left">' + items[i].skuName + '</div>'    
										            + '<div class="mui-media-body">'   
										            	+ '<div class="mui-text-left mui-pull-left">积分<span class="goods-p">' + items[i].skuEarnings + '</span></div>'
										            	+ '<div class="mui-text-right mui-pull-right">已兑<span class="goods-e">' + items[i].exchangeRate + '</span></div>'
										            + '</div>'   
												+'</a>';
													
									//下拉刷新，新纪录插到最前面；
									table.appendChild(li, table.firstChild);
								}
							}
						}
						mui('#pullrefresh').pullRefresh().endPulldownToRefresh();
					});
				}else{
					layer.load(0, {
						shade : false,
						time: 500
					});
					mui('#pullrefresh').pullRefresh().endPulldownToRefresh();
				}
			}
			
			/**
			 * 上拉加载具体业务实现
			 */
			function pullupRefresh() {
				$.post(getRootPath() + "/ins/mall/item/items", {pageNumber:++pageNumber, pageSize:pageSize, sortType:sortType, keyword:keyword}, function(result){
					if(result.state == 0 && result.data && result.data.length > 0){
						var items = result.data;
						var table = document.body.querySelector('.mui-table-view');
						var cells = document.body.querySelectorAll('.mui-table-view-cell');
						for(var i = 0, j = cells.length, len = j + items.length; j < len; i++, j++) {
							var li = document.createElement('li');
							li.setAttribute("itemId", items[i].itemId);
							li.className = 'mui-table-view-cell mui-media mui-col-xs-6';
							li.innerHTML = '<a href="goods_detail.html?id=' + items[i].itemId + '">'
											+ '<img class="mui-media-object" src="' + items[i].imgUrl + '" style="height: 9rem;">'
								            + '<div class="goods-n mui-text-left">' + items[i].skuName + '</div>'    
								            + '<div class="mui-media-body">'   
								            	+ '<div class="mui-text-left mui-pull-left">积分<span class="goods-p">' + items[i].skuEarnings + '</span></div>'
								            	+ '<div class="mui-text-right mui-pull-right">已兑<span class="goods-e">' + items[i].exchangeRate + '</span></div>'
								            + '</div>'   
										+'</a>';
											
							//下拉刷新，新纪录插到最前面；
							table.appendChild(li, table.firstChild);
						}
						mui('#pullrefresh').pullRefresh().endPullupToRefresh();
					}else{
						mui('#pullrefresh').pullRefresh().endPullupToRefresh(true);
					}
				});
			}
			
			mui(".mui-table-view").on('tap','.mui-table-view-cell',function(){
				// 获取商品ID
				var itemId = this.getAttribute("itemId");
				location.href = getRootPath() + '/pages/mallGoods/goods_detail.html?id=' + itemId;
			});
			
			// 切换事件
			mui("#slider").on('tap','.mui-control-item',function(){
				// 0-综合排序  1-销量优先  2-积分
				sortType = $(this).index();
				refresh();
			});
			
			
			function clickSearch(){
				// 是否获取焦点
				var isFocus = $("#searchInput").is(':focus');
				if(!isFocus){
					// 关键字
			        keyword = $("#searchInput").val();
			        refresh();
				}
			}
			
			// 搜索事件
			function enterSearch(e) {
				var value = $("#searchInput").val();
			    if(e.keyCode == 13) {
			        $("#searchInput").blur();
			        // 关键字
			        keyword = value;
			        refresh();
			    }
			}
			// 刷新列表
			function refresh(){
				pageNumber = 1;
				mui('#pullrefresh').pullRefresh().refresh(true);
				pulldownRefresh();
				mui('#pullrefresh').pullRefresh().scrollTo(0,0,0);
			}
			
		</script>
	</body>

</html>