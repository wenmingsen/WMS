<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=0">
    <title>确认订单</title>
    <link rel="stylesheet" type="text/css" href="../../css/bootstrap.min.css" />
    <link rel="stylesheet" type="text/css" href="../../css/weui.css" />
    <link rel="stylesheet" type="text/css" href="../../css/public.css" />
    <link rel="stylesheet" type="text/css" href="../../css/mall.css" />
    <link rel="stylesheet" type="text/css" href="../../css/show_detail.css" />
    <link rel="stylesheet" type="text/css" href="../../css/bootstrap.min.css" />
    <style type="text/css">
    .weui-cell__hd label{
        float:left;
    }
    .weui-cell__bd{
        display:none;
    }
    .container {
	    padding-right: 0;
	    padding-left: 0;
	    margin-right: auto; 
	    margin-left: auto;
	}
	html{
		font-size:inherit;
	}
	.head_navbar_left a i{border-top: 2px solid #f4f4f4;border-left: 2px solid #f4f4f4;}
    </style>
</head>
<body style="background:#f6f6f6;">
    <div class="container">
        <div class="head">
            <div class="head_navbar"  style = "background-color: #184f84;color:white">
                <div class="head_navbar_left">
                    <a class="w-h-35" href="javascript:;" onClick="javascript :history.back(-1);"><i class="back_before"></i></a>
                </div>
                <div class="head_navbar_item"><span style = "text-align:center;font-size: 17px;">确认订单</span>
                </div>
               <!--  <div class="head_navbar_item" id = "orderItem">订单详情</div> -->
            </div>
        </div>
        <div class="look_title" style="display:none" id="logindiv"> 
            <i></i>
            <span id="info"></span>
        </div>
        <div id="shopid">
		        <div class="order_state_wrap">
		        <!-- 地址区 -->
		        <div class="rec_info" style = "border-bottom: 5px solid #dedede;">
		            <div class="weui-cells weui-cells_form" onclick="updatePosition()">
		            	<div style = "width:5%;float:left; margin-top: 1rem;text-align:right">
		            		<span ><a href="#"><span style = "font-size:14px" class="glyphicon glyphicon-map-marker"></span></a></span>
		            	</div>
						<div style = "width:90%; float:left;text-align:">
								<div style="margin:5px 10px;font-size:17px;width:90%;float:none">
		                			<div style = "float:left">
		                				收货人：<span id = "name"></span>
		                			</div>
		                			<div style = "float:right;text-align:right">
		                				<span id = "phone"></span>
		                			</div>
			                	</div>
			                	<br>
			                	<div style="margin:5px 10px;font-size:14px;float:none">
			                		收货地址：<span id = "address_other"></span>
			                	</div>
						</div>
						<div style = "width:5% ; float:left; margin-top: 1rem;text-align:left">
							<span ><a href="#"><span style = "font-size:14px" class="glyphicon glyphicon-chevron-right"></span></a></span>
						</div>		
		            </div>
		            <div id = "colorChange" >
		            	
		            </div>
		        </div>
		        	<!-- 店铺展示 -->
		          	<div class = "storeShow" style = "margin-bottom: 3rem;">
		          		 	<!-- 购买商品展示区 -->
			           
		          	</div>
		        </div>
		        <!--信息区  -->
		       <!--  <div class = "main_panel" >
		        	<div class = "main_panel_info" >
		        		<div class = "panel_title" >兑换优惠：<input  type = "button" style = "color:red"  id = "preferential" value = "包邮 "></div>
		        	</div>
		        	<div class = "main_panel_info">
		        		<div class = "panel_title" >配送方式：<input  type = "button" style = "color:red"  id = "send" value = "快递 "></div>
		        	</div>
		        	<div class = "main_panel_info">
		        		<div class = "panel_title" >留言：<input  type = "text"  style = "width:80%;" id = "remark" placeholder="选填:填写内容已和卖家协商确认 "></div>
		        	</div>
		        </div> -->
		        <div class="set_acc clear">
		            <div class="set_acc_l">
		                合计：<span><span class="num" id = "totalMoney"></span> 积分</span>
		            </div>
		            <span onclick = "insertOrder()" class="set_acc_r">提交订单</span>
		        </div>
		</div>
    </div>
    <script type="text/javascript" src="../../js/jquery.min.js"></script>
    <script type="text/javascript" src="../../js/layer/layer.js"></script>
    <script type="text/javascript" src="../../common/common.js"></script>
    <script type="text/javascript" src="../../js/bootstrap.min.js"></script>
    <script type="text/javascript">
         $(function(){
        	getGoodsId();
        	
         });
         
	/*********查询收货地址 ************/
	function queryPosition(id){
		var url = getRootPath()+"/ins/drtShopAddress/queryAddressList";
    	var params = {};
    	if(id){
    		params.addressId = id;
    	}else{
    		params.isDefault = 0;
    	}
    	$.ajax({
	         type: "post",
	         url: url,
	         data: params,
	         success: function(result){
	        	 if(result=="-1"){
 	     			$("#shopid").hide();
 	     			$("#logindiv").show();
 	     			$("#info").html("请登录！");
 	     			return;
 	     		}
				 if(result.state == 0){
					 setPositionInfo(result.data);
				 }
	         }
	     });
	}
	/*****设置地址信息 *******/
    function setPositionInfo(result){
    	for(var i = 0 ;i< result.length;i++){
    		data.addressId = result[i].addressId;
	    	$("#name").html(result[i].name);
	    	$("#phone").html(result[i].phone);
	    	$("#address_other").html(result[i].addressLevel1+result[i].addressLevel2+result[i].addressLevel3+result[i].addressOther);
    	}
    	
    	
    }
         
         /**增加数量 */
         function addNum(btn,itemId){
        	 var price = parseInt(btn.nextElementSibling.innerHTML);
        	 var n =  parseInt(btn.nextElementSibling.nextElementSibling.innerHTML);
             n++;
             btn.nextElementSibling.nextElementSibling.innerHTML = n;
             
             var totalMoney = parseFloat($("#totalMoney").html());
             $("#totalMoney").html(totalMoney+price);
         }
         
         /**减少数量  */
         function reduceNum(btn,itemId){
        	 var price = parseInt(btn.previousElementSibling.previousElementSibling.innerHTML);
        	 var n = parseInt(btn.previousElementSibling.innerHTML);
             n--;
             if(n<1){
                 n=1;
             }else{
            	 var totalMoney = parseFloat($("#totalMoney").html());
                 $("#totalMoney").html(totalMoney-price);
             }
             btn.previousElementSibling.innerHTML = n;
         }
         /*获取展示商品id   */
       function getGoodsId(){
    	     var orderJson = sessionStorage.getItem("ids");
        	 queryGoodsInfo(orderJson);
        	 var addressId = location.search.split("=")[1];
        	 queryPosition(addressId);
        	 
         }
         
         /*展示商品订单信息  */
     	function queryGoodsInfo(orderJson){
     		var url = getRootPath()+"/ins/mall/order/confirmOrder";
     		var params = {};
     		params.orderJson = orderJson;
     		 $.ajax({
     	         type: "post",
     	         url: url,
     	         data: params,
     	         success: function(result){
     	        	 if(result.state == 0){
     	        		setOrderGoods(result.data);
  					 }
     	         }
     	     });
     	}
     	
     	/****订单创建成功清空购物车 ******/
         function clearShopCart(){
        	 var url = getRootPath()+"/ins/drtShopCart/clearShopCart";
      		 $.ajax({
      	         type: "post",
      	         url: url,
      	         success: function(result){
      	        	
      	         }
      	     });
     	}
        
         
       /**显示订单中的商品 */
       var totalMoney = 0;
       var stores = 0;
       function setOrderGoods(result){  
    	   if(!result){
    		   return;
    	   }
    	   stores = result.length;
    	   var storeShow = $(".storeShow");
    	   storeShow.empty();
    	   for(var i = 0 ; i< stores; i++){
    		   storeShow.append("<div class = 'shopGoodsDetail_"+i+"'></div>")
    		   var storeName = result[i].storeName;
    		   var itemList = result[i].itemList;
	    	   var shopGoodsDetail = $(".shopGoodsDetail_"+i);
	    	   shopGoodsDetail.empty();
	    	   shopGoodsDetail.append('<div class="order_state" style="border-top:0;"> <p id="shopName">'+storeName+' <p class="shopName"></p></p><span class="status"></span></div>')
	    	   for(var j = 0 ;j < itemList.length; j ++){
	    		   var panel =  '<div class="shop_goods_item clear" style = "background-color:#f4f4f4"> '+
		               ' <div class="detail clear"> '+
		                   ' <div class="goods_pic">'+
		                    '    <img src="'+itemList[j].imgUrl+'" style = "width: 91px;height: 93px;" alt="" />'+
		                    '</div>'+
		                    ' <span  style = "display:none" class = "itemId'+i+j+'">'+itemList[j].itemId+'</span> '+
		                    '<div class="goods_con" onclick="goToGoodsDetail(this)">'+
		                     '   <p class="tit order_title" id = "idTitle">'+itemList[j].skuName+'</p>'+
		                      '  <div class="price clear">'+
		                       '     <p class="rmb">积分<span class="rmb_num" id = "needPoints">'+itemList[j].skuEarnings+'</span></p>'+
		                        '</div>'+
		                    '</div>'+
		                '</div>'+
		                '<div class="chos_num clear" value = "'+itemList[j].subtotalEarnings+'">'+
		                '<span style="border:1px solid #dedede" onclick = "addNum(this,&#39;'+itemList[j].itemId+'&#39;)">+</span>'+
		                ' <span  style = "display:none">'+itemList[j].subtotalEarnings+'</span> '+
		                '<span class = "exch_num'+i+j+'" style="border:1px solid #dedede">'+itemList[j].buyAmt+'</span>'+
		                '<span style="border:1px solid #dedede" onclick = "reduceNum(this,&#39;'+itemList[j].itemId+'&#39;)">-</span>'+
		                '</div>'+
		            '</div>';
		            totalMoney = totalMoney+parseInt(itemList[j].skuEarnings)*parseInt(itemList[j].buyAmt);
	    		   shopGoodsDetail.append(panel);
	    	   }
	    	   storeShow.append(' <div class = "main_panel" > '+
		        	'<div class = "main_panel_info" > '+
		        	'	<div class = "panel_title" >兑换优惠：<input  type = "button" style = "color:red"  id = "preferential" value = "包邮 "></div> '+
		        	'</div> '+
		        	'<div class = "main_panel_info"> '+
		        	'	<div class = "panel_title" >配送方式：<input  type = "button" style = "color:red"  id = "send" value = "快递 "></div> '+
		        	'</div> '+
		        	'<div class = "main_panel_info"> '+
		        	'	<div class = "panel_title" >留言：<input  type = "text"  style = "width:80%;" id = "remark'+i+'" placeholder="选填:填写内容已和卖家协商确认 "></div> '+
		        	'</div> '+
		        '</div>');
    	   }
    	   $("#totalMoney").html(totalMoney);
    	   if(sessionStorage.getItem("data")){
   	    	var itemList = JSON.parse(sessionStorage.getItem("data"));
   	    	if(!itemList){
   	    		return;
   	    	}
   	    	var items = itemList.items;
   	    	if(items){
   	    		for(var i = 0 ;i < items.length;i++){
   	    			$('#remark'+i).val(items[i].orderMemberMemo);
   	    			for(var j = 0 ; ; j++){
   	    			   var itemNum = $(".exch_num"+i+j).html()
   	     			   if(!itemNum){
   	     				   break;
   	     			   }
   	     			   $(".exch_num"+i+j).html(items[i].itemNum);
   	    			}
   	    		}
   	    	}
       	}
    	   sessionStorage.setItem("data","");
       }
       
       
       /***跳转***/
       function goToGoodsDetail(btn){
    	   var id = btn.previousElementSibling.innerHTML;
    	   return location.href="goods_detail.html?id="+id;
       }
       
       /**校验地址是否为空 */
       function checkAddress(){
    	   var name = $("#name").html().trim();
    	   if(name==null||name==""){
    		   Toast("收货人姓名不能为空",2000);
    		   return false;
    	   }
	       var phone = $("#phone").html().trim();
	       if(phone == null&&phone==""){
	    	   Toast("收货人联系方式不能为空",2000);
	    	   return false;
	       }
	       var addressOther = $("#address_other").html().trim();
	       if(addressOther == null&&addressOther==""){
	    	   Toast("收货人详细地址不能为空",2000);
	    	   return false;
	       }
	       return true;
       }
       
       /*获取页面商品id,数量 */
        var data = {};
       function getSkuIdSkuNum(){
    	   var items = [];
    	   var num = 0 ;
    	   for(var i = 0 ;i < stores;i++){
    		   var remark = $('#remark'+i).val();
    		   for(var j = 0 ; ; j++){
    			   var item = {};
    			   var itemId = $(".itemId"+i+j).html();
    			   if(!itemId){
    				   break;
    			   }
    			   item.itemId = itemId;
    			   item.itemNum = $(".exch_num"+i+j).html();
    			   item.orderMemberMemo = remark;
	    		   items[num++] = item;
    		   }
    	   }
    	   data.items = items;
    	   return JSON.stringify(data);
       }
       
       /*生成订单  **/
       var orderNo = null;
       var timestamp = new Date().getTime();
       function insertOrder(){
    	   var checkRegx = checkAddress();
    	   if(!checkRegx){
    		   return;
    	   }
    	   var params = {};
    	   params.timestamp = timestamp;
    	   params.orderJson = getSkuIdSkuNum();
    	   var url = getRootPath()+"/ins/mall/order/saveOrder";
    		 $.ajax({
    	         type: "post",
    	         url: url,
    	         data:params,
    	         success: function(result){
    	        	 if(result.state==0){
    	        		sessionStorage.setItem("ids","");
    	        		sessionStorage.setItem("data","");
    	        		goToExchange(result.data);
    	        	}
    	        	setTimeout(function() {
	   	        		timestamp = new Date().getTime();
	   	        		console.log(timestamp);
   					}, 1000);
    	         }
    	     });
       }
       
       /****订单创建成功清空购物车 ******/
       function clearShopCart(){
      	 var url = getRootPath()+"/ins/drtShopCart/clearShopCart";
    		 $.ajax({
    	         type: "post",
    	         url: url,
    	         success: function(result){
    	        	
    	         }
    	     });
   		}
       
       /*******跳转支付页 面  ********/
       function goToExchange(orderIds){
    	   var totalMoney = $("#totalMoney").html();
    	   sessionStorage.setItem("totalMoney",totalMoney+"");
    	   var orderList = {};
    	   orderList.orderIds = orderIds;
    	   sessionStorage.setItem("orderList",JSON.stringify(orderList));
    	   return location.href="payment.html";
       }
       
       /****编辑地址 *********/
       function updatePosition(){
    	   sessionStorage.setItem("data",getSkuIdSkuNum());
    	   return location.href="addressList.html";
       }
       
       /**返回首页 **/
   		function goToMall(){
    	   return location.href="../mall_index.html";
       }
    </script>
</body>
</html>