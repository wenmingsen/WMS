<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no">
	<meta name="apple-mobile-web-app-capable" content="yes">
	<meta name="apple-mobile-web-app-status-bar-style" content="black">
    <title>我的订单</title>
    <link rel="shortcut icon" href="../../css/img/favicon.ico" type="image/x-icon">
    <link rel="stylesheet" type="text/css" href="../../css/weui.css" />
    <link rel="stylesheet" type="text/css" href="../../css/public.css" />
    <link rel="stylesheet" type="text/css" href="../../css/mall.css" />
    <link rel="stylesheet" href="../../css/mui/mui.min.css">
    <link rel="stylesheet" type="text/css" href="../../css/bootstrap.min.css" />

    <style>
			html,
			body {
				background-color: #efeff4;
			}
			.mui-bar~.mui-content .mui-fullscreen {
				top: 44px;
				height: auto;
			}
			.mui-pull-top-tips {
				position: absolute;
				top: -20px;
				left: 50%;
				margin-left: -25px;
				width: 40px;
				height: 40px;
				border-radius: 100%;
			}
			.mui-bar~.mui-pull-top-tips {
				top: 24px;
			}
			.mui-pull-top-wrapper {
				width: 42px;
				height: 42px;
				display: block;
				text-align: center;
				background-color: #efeff4;
				border: 1px solid #ddd;
				border-radius: 25px;
				background-clip: padding-box;
				box-shadow: 0 4px 10px #bbb;
				overflow: hidden;
			}
			.mui-pull-top-tips.mui-transitioning {
				-webkit-transition-duration: 200ms;
				transition-duration: 200ms;
			}
			.mui-pull-top-tips .mui-pull-loading {
				margin: 0;
			}
			.mui-pull-top-wrapper .mui-icon,
			.mui-pull-top-wrapper .mui-spinner {
				margin-top: 7px;
			}
			.mui-pull-top-wrapper .mui-icon.mui-reverse {
				/*-webkit-transform: rotate(180deg) translateZ(0);*/
			}
			.mui-pull-bottom-tips {
				text-align: center;
				background-color: #efeff4;
				font-size: 15px;
				line-height: 40px;
				color: #777;
			}
			.mui-pull-top-canvas {
				overflow: hidden;
				background-color: #fafafa;
				border-radius: 40px;
				box-shadow: 0 4px 10px #bbb;
				width: 40px;
				height: 40px;
				margin: 0 auto;
			}
			.mui-pull-top-canvas canvas {
				width: 40px;
			}
			.mui-slider-indicator.mui-segmented-control {
				background-color: #efeff4;
			}
			.modal-footer{
				border:0px solid;
				text-align:center;
			}
			#myModal{
				margin-top:50%;
			}
			.container {
			    padding-right: 0;
			    padding-left: 0;
			    margin-right: auto; 
			    margin-left: auto;
			}
			html{
				font-size:inherit;
			}
			.modal-dialog{
				width: 70%;
			   	margin-left: 15%;
			}
			.modal-header{
				padding:0px;
				border-bottom:0px solid;
			}
			.modal-body{
				padding:10px;
			}
			.btn-info{
				border:0px solid;
				background-color:red;
			}
			.modal-footer{
				padding:0px;
				color:blue;
			}
			input, button, select, textarea {
		   		line-height: initial;
			}
			.mui-bar {
				background-color: #184f84;
			}
			.mui-bar .mui-title {
				color: #f4f4f4;
			}
			.mui-bar .mui-icon {
				color: #f4f4f4;
			}
		</style>
</head>
<body style="background:#f6f6f6;">
	<header class="mui-bar mui-bar-nav">
	    <h1 class="mui-title">我的订单</h1>
	    <span class="mui-icon mui-icon-left-nav mui-pull-left"></span>
	    <button onclick="goToMall()" style="background-color: #184f84;color: white;margin-left: 79%;margin-top: 1%;border-color:#184f84;">关闭</button>
	</header>
    <div class="container">
         <div class="look_title" style="display:none" id="logindiv"> 
            <i></i>
            <span id="info"></span>
        </div>
        <div id="shopOrder">
		        <div class="weui-navbar" style="margin-top: 43px;">
		            <div class="weui-navbar__item weui-navbar__item_on" onclick="stateClick(9999)">
		                全部订单
		            </div>
		            <div class="weui-navbar__item" onclick="stateClick(1)">
		                待兑换
		            </div>
		            <div class="weui-navbar__item" onclick="stateClick(2)">
		                待发货
		            </div>
		            <div class="weui-navbar__item" onclick="stateClick(3)">
		                待收货
		            </div>
		            <div class="weui-navbar__item" onclick="stateClick(4)">
		                已完成
		            </div>
		        </div><div style="height:50px;"></div>
		         <div class="mui-slider-group">
						<div class="mui-content mui-scroll-wrapper" id='pullrefresh'>
							<div class="mui-scroll">
			        			<div id="shoporder" style = 'padding-top:88px;'></div>
			        		</div>
			       	 	</div>
		       	 </div> 
		        <div style="height:80px;"></div>
		   </div>
    </div>
    
    
           	<!-- 模态框 -->
<div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
			<div class="modal-dialog">
				<div class="modal-content">
					<div class="modal-header">
						<h3 class="modal-title text-center" id="myModalLabel1" style = " padding-top: 10px;">操作提示</h3>
					</div>
					<div class="modal-body">
						<form id="userAddForm" method="post">
								<div class="tab-pane fade in active"  style = "text-align:center" id='confirm'>
										<p>确定取消吗？</p>
								</div>
						</form>	
				</div>
				<div class="modal-footer" style = "border-top:1px solid #dedede;">
					<div   onclick="submit1()" data-dismiss="modal" style = "width:50%;float:left;text-align:center;padding: 15px; border-right: 1px solid #dedede;">  
                       	<b>是</b>  
                   	</div>
                   	<div   style = "width:50%;float:right;text-align:center;padding: 15px;" data-dismiss="modal">  
                       	<b>否</b>  
                   	</div>
				</div>
			</div>
			<!-- /.modal-content -->
		</div>
		<!-- /.modal -->
</div>
    <script type="text/javascript" src="../../js/jquery.min.js"></script>
    <script type="text/javascript" src="../../js/layer/layer.js"></script>
    <script type="text/javascript" src="../../common/common.js"></script>
    <script src="../../js/mui/mui.min.js"></script>
	<script src="../../js/mui/mui.pullToRefresh.js"></script>
	<script src="../../js/mui/mui.pullToRefresh.material.js"></script>
	<script type="text/javascript" src="../../js/bootstrap.min.js"></script>
	
    <script>
    var pageNumber = 1;
    var pageSize = 10;
    var state = 9999;
    var firstLoad=true;//页面首次加载
    mui.init();
	$('.weui-navbar__item').on('click', function () {
           $(this).addClass('weui-navbar__item_on').siblings().removeClass('weui-navbar__item_on');
       });
		
	$(function(){
		var str = location.search;
    	if(str.search("me")==-1){
    		$(".head_navbar_left").empty();
    		$(".head_navbar_left").append('<a class="w-h-35" href="mall_index.html"><i class="back_before"></i></a>');
    	}
    	 queryShopOrder(state,pageNumber,pageSize);
	});
	
	 
	mui.init({
		swipeBack: false,
		pullRefresh: {
			container: '#pullrefresh',
			down: {
				style:'circle',
				auto: true,//可选,默认false.首次加载自动上拉刷新一次
				callback: function() {
					console.log("下拉");
					/* pageNumber = 1;*/
					if(firstLoad){
						queryShopOrder(state,pageNumber,pageSize);
					}
					mui('#pullrefresh').pullRefresh().endPulldownToRefresh();
				}
			},
			up: {
				contentrefresh: '正在加载...',
				callback: function() {
					console.log("上拉");
					pageNumber++;
					queryShopOrder(state,pageNumber,pageSize);
					//this.endPullUpToRefresh(false);
					mui('#pullrefresh').pullRefresh().endPullupToRefresh();
				}
			}
		}
	}); 
	
	/* (function($) {
        //阻尼系数
    		$.ready(function() {
    			//循环初始化所有下拉刷新，上拉加载。
    			$.each(document.querySelectorAll('.mui-slider-group .mui-scroll'), function(index, pullRefreshEl) {
    				$(pullRefreshEl).pullToRefresh({
    					 down: {
    						contentrefresh: '数据加载中...',
    						auto:true,
    						callback: function() {
    							console.log("下拉");
    							// pageNumber = 1;
    							if(firstLoad){
    								queryShopOrder(state,pageNumber,pageSize);
    							}
    							this.endPullDownToRefresh(true); 
    						}
    					}, 
    					up: {
    							contentinit: '',
    							contentdown: '',
    							contentrefresh: '数据加载中...',
    							contentnomore: '',
    							callback: function() {
    								console.log("上拉");
    								pageNumber++;
    								queryShopOrder(state,pageNumber,pageSize);
    								this.endPullUpToRefresh(false);
    						}
    					}
    				});
    			});
    		});
	})(mui); */
       //获取用户所有订单
       function queryShopOrder(state,pageNumber,pageSize){
       	var data={};
       	data.orderState=state;
       	data.pageNumber = pageNumber;
       	data.pageSize = pageSize;
       	var ctx=getRootPath();
       	$.ajax({
       		async: false,
			url : ctx+'/ins/mall/order/orderList',
			data : data,
			type : "POST",
			success : function(result) {
				if(result.state=="-1"){
   	     			$("#shopOrder").hide();
   	     			$("#logindiv").show();
   	     			$("#info").html(result.message);
   	     			return;
   	     		}else{
	   	     		if(result!=null){
						if(result.data!=null){
							var orders = result.data;
							if(orders.length==0){
								if(firstLoad){
									$("#shoporder").html("");
						       		$("#shoporder").append('<div id="noclass" style="width: 100%;  text-align: center; position: relative;background-color:#EFEFF4;padding-top:20px;">'+    	
											'<img src="../../css/img/order_empty.png" style="width:27%;margin: 90px auto 0;">'+
											'<div style="padding: 15px; color: #999;font-size: 17px;">您还没有相关的订单<br>去挑几件好货吧！</div></div>')
								}else{
									pageNumber--;
								}
							}else{
								 //首次加载清空页面
								 if(firstLoad){
									 $("#shoporder").html("");
								 }
								for(var i=0;i<orders.length;i++){
									var stateHtml='';
									if(orders[i].orderState==1){
										stateHtml='<p class="wait_sent">待兑换</p>';
									}else if(orders[i].orderState==3){
										stateHtml='<p class="sent">待收货</p>';
									}else if(orders[i].orderState==2){
										stateHtml='<p class="wait_sent">待发货</p>';
									}else if(orders[i].orderState==4){
										stateHtml= '<p class="complate">已完成</p>';
									}else{
										stateHtml= '<p class="complate">已取消</p>';
									}
									var orderHtml='<div class="order_state_wrap" style="margin-top:5px;">'+
							            '<div class="order_state" id="'+i+'">'+
							               ' <p class="order_num">'+orders[i].storeName+'</p>'+stateHtml+
							            '</div>'
						            var orderNo = orders[i].orderCode;
									var orderSons=orders[i].orderDetailList;
							        var  sumEarnings = orders[i].orderTotalEarnings;
							        var  orderCount = 0
							        
									for(var j=0;j<orderSons.length;j++){
										var  html='';
											orderCount=orderCount+orderSons[j].buyAmt;
											html='<div class="shop_goods_item clear" data-orderid="'+ orders[i].orderId +'">'+
							                '<div class="detail clear">'+
							                '<a href="javascript:;" class="detail_mask"></a>'+
							                   ' <div class="goods_pic">'+
							                        '<img src="'+orderSons[j].imgUrl+'" style="width: 100%;" alt="" />'+
							                   ' </div>'+
							                   ' <div class="goods_con">'+
							                       ' <p class="tit order_title">'+orderSons[j].skuName+'</p>'+
							                       ' <div class="price clear">'+
							                           ' <p class="rmb"><span class="num">积分</span>'+orderSons[j].skuEarnings+'</p>'+
							                        '</div>'+
							                   ' </div>'+
							                '</div>'+
							               ' <div class="buy_num">x'+orderSons[j].buyAmt+'</div>'+
							            '</div>'
							               orderHtml=orderHtml+html;
									}
									orderHtml = orderHtml+'<div style="text-align:right;padding:5px;margin-right:5px;font-size:.75rem;">共'+orderCount+'件商品&nbsp;&nbsp;合计(积分)：'+'<font size="3";color="#F35757">'+sumEarnings+'</font></div>';
									 if(orders[i].orderState==1){
										 orderHtml +='<div class="order_state">';
										orderHtml += '<input type="button" value="兑换"  class="pay" onclick="fk(\''+orders[i].orderId+'\', \''+orders[i].orderTotalEarnings+'\')">'+
						                '<input type="button" value="取消订单"  class="confirm" onclick="operateConfirm(&quot;'+orders[i].orderId+'&quot;,5)">';
										orderHtml += '</div>';
									 }else if(orders[i].orderState==3|| orders[i].orderState==4){
										orderHtml +='<div class="order_state" style="padding: 0;">';
										if(orders[i].orderState==3){
											orderHtml +='<input type="button" value="确认收货"  class="confirm" style="background: #184f84;color: #fff;"  onclick="operateConfirm(&quot;'+orders[i].orderId+'&quot;,4)">';
										}
										orderHtml +='<input type="button" value="查看物流" class="confirm" onclick="queryLogistics(&quot;'+orders[i].orderId+'&quot;)">';
						                orderHtml += '</div>';
									 }
									 $("#shoporder").append(orderHtml);
					        	}
							}
						}
					}
   	     		}
			}
		});
       	firstLoad = false;
       }
        
        
        //根据状态获取订单
        /* function stateClick(s){
        	state = s;
        	firstLoad = true;
        	pageNumber=1;
        	//queryShopOrder(state,pageNumber,pageSize);
        	var scroll=document.querySelector('.mui-scroll')
        	mui(scroll).pullToRefresh().pullDownLoading();//模拟触发下拉
        } */
     function stateClick(s){
        	state = s;
        	firstLoad = true;
        	pageNumber=1;
			mui('#pullrefresh').pullRefresh().refresh(true);
			queryShopOrder(state,pageNumber,pageSize);
			mui('#pullrefresh').pullRefresh().scrollTo(0,0,0); 
        }
        
        /* 操作确认提示 */
        function　operateConfirm(id,orderState){
        	$("#myModal").modal();
        	var text = '确定取消订单？';
        	if(orderState == 4){//确认收货
        		text = '确认收货？';
        	}
        	$("#confirm").text(text);
        	$("#myModal").data("id",id);
        	$("#myModal").data("orderState",orderState);
        }
        function submit1(){
        	var id = $("#myModal").data("id");
        	var orderState = $("#myModal").data("orderState");
        	qrsh(id,orderState);
        }
        
        //确认收货/取消订单
        function qrsh(orderId,orderState){
         	 var data={};
        	data.orderId=orderId;
        	var url = getRootPath()+'/ins/mall/order/';
        	if(orderState == 5){//取消订单
        		url+='cancleOrder';
        	}else{//确认收货
        		url+='synReceiptConfrim';
        	}
        	$.ajax({
				url : url,
				data : data,
				type : "POST",
				success : function(result) {
					$("#shoporder").html("");
					//默认显示五条
		            queryShopOrder(9999,pageNumber,pageSize);
		            Toast(result.message,2000);
		            if(result.state == 0){
			            	$("#myModal").data("id","");
			            	$("#myModal").data("orderState","");
			            }
					} 
				});
        }
        
        //付款
        function fk(orderId, totalEarnings){
        	sessionStorage.setItem("totalMoney",totalEarnings+"");
     	   var orderList = {};
     	   orderList.orderIds = new Array(orderId);
     	   sessionStorage.setItem("orderList",JSON.stringify(orderList));
     	   return location.href="payment.html";
        }

        //查看物流
        function queryLogistics(orderId){
        	location.href="logistics.html?id="+orderId;
        }
        
        mui("body").on('tap','.shop_goods_item',function(){
        	var orderIds = this.getAttribute("data-orderid");
			location.href = "orderDetail.html?orderIds=" + orderIds;
        });
        
        mui(".mui-bar-nav").on('tap','.mui-icon-left-nav',function(){
    		history.back(-1);
    	})
    	function goToMall(){
    		location.href = "main.html"
    	}
    </script>
</body>
</html>