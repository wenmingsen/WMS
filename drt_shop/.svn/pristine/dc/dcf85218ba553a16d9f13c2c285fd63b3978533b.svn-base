<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=0">
    <title>收货信息</title>
    <link rel="stylesheet" type="text/css" href="../css/weui.css" />
    <link rel="stylesheet" type="text/css" href="../css/public.css" />
    <link rel="stylesheet" type="text/css" href="../css/mall.css" />
    <link rel="stylesheet" type="text/css" href="../css/address.css" />
    <link rel="stylesheet" type="text/css" href="../css/mui.picker.css" />
    <link rel="stylesheet" type="text/css" href="../css/mui.poppicker.css" />
</head>
<body style="background:#f6f6f6;" >
    <div class="container">
        <div class="head">
            <div class="head_navbar" style = "background-color: #184f84;color:white">
                <div class="head_navbar_left">
                    <a href="javascript:history.go(-1);" class="w-h-35" ><i class="back_before"></i></a>
                </div>
                <div class="head_navbar_item">收货信息</div>
            </div>
            <div class="head_navbar_r save">
              
            </div>
        </div>
        <div class="rec_info" style="border-top:0;">
            <div class="weui-cells weui-cells_form">
                <div class="weui-cell pad_15">
                    <div class="weui-cell__hd"><label class="weui-label" style = "color:black">收货人：</label></div>
                    <div class="weui-cell__bd">
                        <input class="weui-input" type="text" style = "font-size:16px" placeholder="" id = "name">
                    </div>
                </div>
                <div class="weui-cell pad_15">
                    <div class="weui-cell__hd"><label class="weui-label" style = "color:black">联系电话 ：</label></div>
                    <div class="weui-cell__bd">
                        <input class="weui-input" type="number" style = "font-size:16px" id = "phone">
                    </div>
                </div>
                 <div class="weui-cell pad_15">
                 	<div id='showCityPicker3' class="mui-btn mui-btn-block" style = "width:100%">
						<span id='showCityPicker3' class="mui-btn mui-btn-block" >省市县(区)：</span><input id = "cityResult3"  readonly = "true" style = "width: 72%;font-size:18px" value = "" onBlur = "closeCityAddress()"  placeholder="">
					</div> 
				</div>
                <div class="weui-cell pad_15">
                    <div class="weui-cell__hd"><label class="weui-label" style = "color:black">收货地址 ：</label></div>
                    <div class="weui-cell__bd">
                        <input class="weui-input" type="text" style = "font-size:16px" id = "address_other" maxlength="100">
                    </div>
                </div>
            </div>
        </div>
        <div>
        	<div id = "ensure" onclick = "submitPosition()">保存</div>
        </div>
       
    </div>
     <script type="text/javascript" src="../js/jquery.min.js"></script>
     <script type="text/javascript" src="../js/layer/layer.js"></script>
     <script type="text/javascript" src="../common/common.js"></script>
     <script type="text/javascript" src="../js/mui.min.js"></script>
     <script type="text/javascript" src="../js/mui.picker.js"></script>
     <script type="text/javascript" src="../js/mui.poppicker.js"></script>
      <script type="text/javascript" src="../js/cityData3.js"></script>
    <script type="text/javascript">
    /***************初始化修改地址 **************************/
  	var orderId = null;
  	var addressLevel1Id = null;
  	var addressLevel2Id = null;
  	var addressLevel3Id = null;
  	var strOrderId = null;
  	var id = null;
    $(function(){
	    	//清楚已存地址信息  
	    	$("#name").val();
	    	$("#phone").val();
	    	$("#address_other").val();
    	 var str = location.search.split("?")[1];
    	 strOrderId = location.search.split("?")[2];
    	 if(strOrderId!=null&&strOrderId.search("back")!=-1){
    		 strOrderId = "backHistory";
    	 }
  	 	 var idAll = str.split('=')[1];
  	 	 if(str.search("orderId")==-1){
  	 		 //修改地址 
	  	 	 id = idAll.split("&")[0];
	 		 addressLevel1Id = idAll.split("&")[1];
	 		 addressLevel2Id = idAll.split("&")[2];
	 		 addressLevel3Id = idAll.split("&")[3];
	 		 orderId = idAll.split("&")[4];
  	 		 queryAddress(id);
  	 	 }else{
  	 		 //新增地址 
  	 		 orderId = idAll.split("&")[0];
  	 		 strOrderId = idAll.split("&")[1]
  	 	 }
    });
	
    
    /*****查询要修改的地址 **********/
    function queryAddress(id){
    	var url = getRootPath()+"/ins/drtShopAddress/queryAddressList";
    	var params = {};
    	params.addressId = id;
    	params.addressLevel1Id = addressLevel1Id;
    	params.addressLevel2Id = addressLevel2Id;
    	$.ajax({
	         type: "post",
	         url: url,
	         data: params,
	         success: function(result){
				 if(result.state == 0){
					 setPositionInfo(result.data);
				 }
	         }
	     });
    }
    function setPositionInfo(result){
    	if(!result[0]){
    		return;
    	}
    	$("#name").val(result[0].name);
    	$("#phone").val(result[0].phone);
    	$("#cityResult3").val(result[0].addressLevel1+" "+result[0].addressLevel3+" "+result[0].addressLevel3);
    	addressList[0]= result[0].addressLevel1Id;
		addressList[1]= result[0].addressLevel1;
		addressList[2]= result[0].addressLevel2Id;
		addressList[3]= result[0].addressLevel2;
		addressList[4]= result[0].addressLevel3Id;
		addressList[5]= result[0].addressLevel3;
    	$("#address_other").val(result[0].addressOther);
    	$(".container").data("id",result[0].addressId);
    	
    }
    /************保存地址 *************************/
    function submitPosition(){
    	var url = null;
		var params = {};
		var id = $(".container").data("id");
		if(id){
			params.addressId = id ;
			url = getRootPath()+"/ins/drtShopAddress/updateAddress";
		}else{
			url = getRootPath()+"/ins/drtShopAddress/addAddress";
			params.isDefault = 0;
		}
 		var name = $("#name").val();
 		var phone = $("#phone").val();
 		var addressOther = $("#address_other").val();
 		var flag = checkedInfo(name,phone,addressOther);
 		if(!flag){
 			return;
 		}
 		params.name = name;
 		params.phone = phone;
 		params.addressOther = addressOther;
 		params.addressLevel1Id = addressList[0];
 		params.addressLevel1 = addressList[1];
 		params.addressLevel2Id = addressList[2];
 		params.addressLevel2 = addressList[3];
 		params.addressLevel3Id = addressList[4];
 		params.addressLevel3 = addressList[5];
 		
 		 $.ajax({
 	         type: "post",
 	         url: url,
 	         data: params,
 	         success: function(result){
 	        	if(result.message){
   	        	 Toast(result.message,2000);
	        	 }
 	        	if(result.state==0){
	 	        	return location.href="addressList.html?"+strOrderId;
 	        	}
 	         }
 	     });
    }
    
    
    /*******校验 *******/
    function checkedInfo(name,phone,addressOther){
    	name =  $.trim(name);
   		if(!name){
   			Toast("收货人不能为空 ",2000);
   			return false;
   		}
   		var regx = /^((0\d{2,3})-)(\d{7,8})(-(\d{3,}))?$/;
   		var regx1 = /[0-9]{11}/;
   		if(!regx.test(phone)){
   			if(!regx1.test(phone)){
	   			Toast("请填写正确联系方式 ,如：13916752109或0712-3614072",2000);
	   			return false;
   			}
   		}
   		if(addressList.length==0){
   			Toast("省市级不能为空 ",2000);
   			return false;
   		}
   		addressOther = $.trim(addressOther);
   		if(!addressOther){
   			Toast("收货地址不能为空  ",2000);
   			return false;
   		}
   		return true;
    }
    
    /*监听光标离开,关闭地址选项 */
    function closeCityAddress(){
 	   cityPicker3.hide();
    }
    /*设置城市 */
    function setCityAddress(cityAddress){
     	$("#cityResult3").val(cityAddress);
     }
    
    /*省市地址 */
    var addressList = [];
    var cityPicker3;
	(function($, doc) {
		$.init();
		$.ready(function() {
			cityPicker3 = new $.PopPicker({
				layer: 3
			});
			cityPicker3.setData(cityData3);
			var showCityPickerButton = doc.getElementById('showCityPicker3');
			var cityResult3 = doc.getElementById('cityResult3');
			showCityPickerButton.addEventListener('tap', function(event) {
				cityPicker3.show(function(items) {
					var cityAddress =  (items[0] || {}).text + " " + (items[1] || {}).text + " " + (items[2] || {}).text;
					setCityAddress(cityAddress);
					addressList[0]=(items[0] || {}).value;
					addressList[1]=(items[0] || {}).text;
					addressList[2]=(items[1] || {}).value;
					addressList[3]=(items[1] || {}).text;
					addressList[4]=(items[2] || {}).value;
					addressList[5]=(items[2] || {}).text;
					//返回 false 可以阻止选择框的关闭
					//return false;
				});
			}, false);
		});
	})(mui, document);
    </script>
</body>
</html>