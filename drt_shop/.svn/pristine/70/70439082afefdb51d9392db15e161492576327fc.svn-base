<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=0">
    <title>订单详情</title>
    <link rel="stylesheet" type="text/css" href="../../css/weui.css" />
    <link rel="stylesheet" type="text/css" href="../../css/public.css" />
    <link rel="stylesheet" type="text/css" href="../../css/mall.css" />
    <style type="text/css">
    .weui-cell__hd label{
        float:left;
    }
    .weui-cell__bd{
        display:none;
    }
    </style>
</head>
<body style="background:#f6f6f6;">
    <div class="container">
        <div class="head">
            <div class="head_navbar"  style = "background-color: #184f84;color:white">
                <div class="head_navbar_left">
                    <a class="w-h-35" href="javascript:;" onClick="javascript :history.back(-1);"><i class="back_before"></i></a>
                </div>
                <div class="head_navbar_item"><span style = "text-align:center;margin-left:30%;">订单详情</span>
                </div>
               <!--  <div class="head_navbar_item" id = "orderItem">订单详情</div> -->
            </div>
        </div>
        <div class="look_title" style="display:none" id="logindiv"> 
            <i></i>
            <span id="info"></span>
        </div>
        <div id="shopid">
		        <div class="order_state_wrap">
		            	<!-- 购买商品展示区 -->
		            <div id = "shopGoodsDetail">
		            
		            </div>
		        </div>
		        <div class="rec_info">
		            <div class="rec_info_title clear">
		                <div class="tit_f_l">收货信息</div>
		                <div class="tit_f_r" onclick = "updatePosition()">
		                    <i><img src="../../css/img/editor.png" height="14" alt="" /></i>
		                    编辑地址
		                </div>
		            </div>
		            <div class="weui-cells weui-cells_form">
		                <div class="weui-cell pad_15">
		                    <div class="weui-cell__hd">
		                        <label class="weui-label">收货人：</label>
		                        <label id = "name">*******</label>
		                    </div>
		                    <div class="weui-cell__bd">
		                        <input class="weui-input" type="text" placeholder="">
		                    </div>
		                </div>
		                <div class="weui-cell pad_15">
		                    <div class="weui-cell__hd">
		                        <label class="weui-label">联系电话 :</label>
		                        <label id = "phone">*******</label>
		                    </div>
		                    <div class="weui-cell__bd">
		                        <input class="weui-input" type="number" >
		                    </div>
		                </div>
		                <div class="weui-cell pad_15">
		                    <div class="weui-cell__hd">
		                        <label class="weui-label">收货地址 :</label>
		                        <label id = "address_other">*********</label>
		                    </div>
		                    <div class="weui-cell__bd">
		                        <input class="weui-input" type="text" >
		                    </div>
		                </div>
		            </div>
		        </div>
		        <div style="height:80px;"></div>
		        <div class="set_acc clear">
		            <div class="set_acc_l">
		                合计：<span><span class="num" id = "totalMoney">***</span> 积分</span>
		            </div>
		            <span onclick = "insertOrder()" class="set_acc_r">提交订单</span>
		        </div>
		</div>
    </div>
    <script type="text/javascript" src="../../js/jquery.min.js"></script>
    <script type="text/javascript" src="../../common/common.js"></script>
    <script type="text/javascript">
         $(function(){
        	getGoodsId();
        	
         });
         
	/*********查询收货地址 ************/
	function queryPosition(id){
		var url = "/"+getRoot()+"/ins/drtShopAddress/queryAddressList";
    	var params = {};
    	if(id){
    		params.id = id;
    	}else{
    		params.isDefault = 0;
    	}
    	$.ajax({
	         type: "get",
	         url: url,
	         data: params,
	         success: function(result){
	        	 if(result=="-1"){
 	     			$("#shopid").hide();
 	     			$("#logindiv").show();
 	     			$("#info").html("请登录！");
 	     			return;
 	     		}
				 if(result.state == 0){
					 setPositionInfo(result.data);
				 }
	         }
	     });
	}
	/*****设置地址信息 *******/
    function setPositionInfo(result){
    	for(var i = 0 ;i< result.length;i++){
	    	$("#name").html(result[i].name);
	    	$("#phone").html(result[i].phone);
	    	$("#address_other").html(result[i].addressOther);
    	}
    }
         
         /**增加数量 */
         function addNum(btn,itemId){
        	 var price = parseInt(btn.nextElementSibling.innerHTML);
        	 var n =  parseInt(btn.nextElementSibling.nextElementSibling.innerHTML);
             n++;
             btn.nextElementSibling.nextElementSibling.innerHTML = n;
             
             var totalMoney = parseInt($("#totalMoney").html());
             $("#totalMoney").html(totalMoney+price);
             if(!id){
	             changeItemNum(itemId,n);
             }
         }
         
         /**减少数量  */
         function reduceNum(btn,itemId){
        	 var price = parseInt(btn.previousElementSibling.previousElementSibling.innerHTML);
        	 var n = parseInt(btn.previousElementSibling.innerHTML);
             n--;
             if(n<1){
                 n=1;
             }else{
            	 var totalMoney = parseInt($("#totalMoney").html());
                 $("#totalMoney").html(totalMoney-price);
             }
             btn.previousElementSibling.innerHTML = n;
             if(!id){
	             changeItemNum(itemId,n);
             }
         }
         /*获取展示商品id   */
         var id = null;
         var addressId = null;
       function getGoodsId(){
        	 var str = location.search;
        	 if(str.search("orderId")==-1){
	        	 id = str.split('=')[1];
        	 }else{
        		 id = str.split('=')[1].split("&")[0];
        		 if(id.search("undefined")!=-1){
        			 id = null;
        		 }
        		 addressId = str.split('=')[2];
        	 }
        	 queryGoodsInfo(id);
        	 queryPosition(addressId);
        	 
         }
         
         /*展示商品订单信息  */
     	function queryGoodsInfo(id){
     		var url = "/"+getRoot()+"/ins/drtShopOrderDetail/queryGoodsInfo";
     		var params = {};
     		if(id){
     			params.id = id;
     		}
     		 $.ajax({
     	         type: "GET",
     	         url: url,
     	         data: params,
     	         success: function(result){
     	        	 if(result.state == 0){
     	        		setOrderGoods(result.data);
  					 }
     	         }
     	     });
     	}
     	
     	/****订单创建成功清空购物车 ******/
         function clearShopCart(){
        	 var url = "/"+getRoot()+"/ins/drtShopCart/clearShopCart";
      		 $.ajax({
      	         type: "GET",
      	         url: url,
      	         success: function(result){
      	        	
      	         }
      	     });
     	}
        
         
       /**显示订单中的商品 */
       var totalMoney = 0;
       function setOrderGoods(result){    	 
    	   var shopGoodsDetail = $("#shopGoodsDetail");
    	   shopGoodsDetail.empty();
    	   for(var i = 0 ;i < result.length; i ++){
    		   if(result[i].itemNum==null){
    			   result[i].itemNum=1;
    		   }
    		   var panel = '<div class="shop_goods_item clear"> '+
	               ' <div class="detail clear"> '+
	                   ' <div class="goods_pic">'+
	                    '    <img src="'+fileServer+result[i].itemPicture+'" width="100%" alt="" />'+
	                    '</div>'+
	                    ' <span  style = "display:none">'+result[i].id+'</span> '+
	                    '<div class="goods_con" onclick="goToGoodsDetail(this)">'+
	                     '   <p class="tit order_title" id = "idTitle">'+result[i].itemName+'</p>'+
	                      '  <div class="price clear">'+
	                       '     <p class="rmb"><span class="rmb_num" id = "needPoints">'+result[i].itemEarnings+'</span></p>'+
	                        '</div>'+
	                    '</div>'+
	                '</div>'+
	                '<div class="chos_num clear" value = "'+result[i].itemEarnings+'">'+
	                '<span style="border:1px solid #dedede" onclick = "addNum(this,'+result[i].id+')">+</span>'+
	                ' <span  style = "display:none">'+result[i].itemEarnings+'</span> '+
	                '<span class = "exch_num" style="border:1px solid #dedede">'+result[i].itemNum+'</span>'+
	                '<span style="border:1px solid #dedede" onclick = "reduceNum(this,'+result[i].id+')">-</span>'+
	                '</div>'+
	            '</div>';
	            totalMoney = totalMoney+parseInt(result[i].itemEarnings)*parseInt(result[i].itemNum);
    		   shopGoodsDetail.append(panel);
    	   }
    	   $("#totalMoney").html(totalMoney);
       }
       
       
       /***跳转***/
       function goToGoodsDetail(btn){
    	   var id = btn.previousElementSibling.innerHTML;
    	   return location.href="goods_detail.html?id="+id;
       }
       
       /*生成订单  **/
       var orderNo = null;
       function insertOrder(){
    	   var params = {};
    	   var date = new Date().toLocaleString().split(" ")[0].replace("/","").replace("/","");
    	   orderNo = date+parseInt(Math.random()*100000);
    	   params.orderNum = orderNo;
    	   if(id){
    		   params.id = id;
    		   params.itemNum = $(".exch_num").html();
    	   }else{
    		   params.id = null;
    		   params.itemNum = null;
    	   }
    	  params.name = $("#name").html();
	      params.phone = $("#phone").html();
	      params.address = $("#address_other").html();
    	   var url = "/"+getRoot()+"/ins/drtShopOrderDetail/insertOrder";
    		 $.ajax({
    	         type: "post",
    	         url: url,
    	         data:params,
    	         success: function(result){
    	        	 if(result.message){
    	        		 Toast(result.message,2000);
    	        	 }
    	        	 if(result.state==0){
    	        		clearShopCart();
    	        		goToExchange(result.data);
    	        	}
    	         }
    	     });
       }
       
       /****订单创建成功清空购物车 ******/
       function clearShopCart(){
      	 var url = "/"+getRoot()+"/ins/drtShopCart/clearShopCart";
    		 $.ajax({
    	         type: "GET",
    	         url: url,
    	         success: function(result){
    	        	
    	         }
    	     });
   		}
       
       /******改变商品数量 *******/
    	function changeItemNum(id,itemNum){
    		var url = "/"+getRoot()+"/ins/drtShopCart/changeItemNumById";
    		var params = {};
    		params.id = id
    		params.itemNum = itemNum;
    		 $.ajax({
    	         type: "GET",
    	         url: url,
    	         data: params,
    	         success: function(result){
    	        	 
    	         }
    	     });
    	}
    	
       
       /*******跳转支付页 面  ********/
       function goToExchange(orderId){
    	   var totalMoney = $("#totalMoney").html();
    	   return location.href="payment.html?totalMoney="+totalMoney+"&"+orderId+"&"+orderNo;
       }
       
       /****编辑地址 *********/
       function updatePosition(){
    	   return location.href="../../addressList.html?orderId=&id="+id;
       }
       
       /**返回首页 **/
   		function goToMall(){
    	   return location.href="../../mall_index.html";
       }
    </script>
</body>
</html>