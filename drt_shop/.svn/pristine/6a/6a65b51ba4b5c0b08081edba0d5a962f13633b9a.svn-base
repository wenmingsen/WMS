<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.csg.intshop.mapper.DrtShopOrderDetailMapper">
	<resultMap id="BaseResultMap" type="com.csg.intshop.entity.DrtShopOrderDetail">
		<id column="id" property="id"></id>
		<result column="order_id" property="orderId" />
		<result column="item_id" property="itemId" />
		<result column="order_state" property="orderState" />
		<result column="creator_id" property="creatorId" />
		<result column="creator_name" property="creatorName" />
		<result column="create_time" property="createTime" />
		<result column="modify_id" property="modifyId" />
		<result column="modify_name" property="modifyName" />
		<result column="modify_time" property="modifyTime" />
		<result column="item_num" property="itemNum" />
		<result column="item_earnings" property="itemEarnings" />
		<result column="remark" property="remark" />
		<result column="phone" property="phone" />
		<result column="name" property="name" />
		<result column="postcode" property="postcode" />
	</resultMap>
	
	<sql id="BaseColumnList">
		id as id,
		order_id as orderId,
		item_id as itemId,
		order_state as orderState,
		creator_id as creatorId,
		creator_name as creatorName,
		create_time as createTime,
		modify_id as modifyId,
		modify_name as modifyName,
		modify_time as modifyTime,
		item_num as itemNum,
		item_earnings as itemEarnings,
		remark as remark,
		phone as phone,
		name as name,
		postcode as postcode
	</sql>

	<sql id="BaseCustomQueryCondition">
		<if test="id != null">
			and id=#{id}
		</if>
		<if test="orderId != null">
			and order_id=#{orderId}
		</if>
		<if test="itemId != null">
			and item_id=#{itemId}
		</if>
		<if test="orderState != null">
			and order_state=#{orderState}
		</if>
		<if test="creatorId != null">
			and creator_id=#{creatorId}
		</if>
		<if test="creatorName != null">
			and creator_name=#{creatorName}
		</if>
		<if test="createTime != null">
			and create_time=#{createTime}
		</if>
		<if test="modifyId != null">
			and modify_id=#{modifyId}
		</if>
		<if test="modifyName != null">
			and modify_name=#{modifyName}
		</if>
		<if test="modifyTime != null">
			and modify_time=#{modifyTime}
		</if>
		<if test="itemNum != null">
			and item_num=#{itemNum}
		</if>
		<if test="itemEarnings != null">
			and item_earnings=#{itemEarnings}
		</if>
		<if test="remark != null">
			and remark=#{remark}
		</if>
		<if test="phone != null">
			and phone=#{phone}
		</if>
		<if test="name != null">
			and name=#{name}
		</if>
		<if test="postcode != null">
			and postcode=#{postcode}
		</if>
	</sql>

	<!--创建主订单  -->
	<insert id = "insertOrder" parameterType = "com.csg.intshop.entity.DrtShopOrder">
		insert into drt_shop_order 
		(id,account_id,order_earnings,order_no,order_state,creator_id,create_time,name,phone,address,address_id)
		values
		(#{id},#{accountId},#{orderEarnings},#{orderNo},1,#{accountId},#{createTime},#{name},#{phone},#{address},#{addressId})
	</insert>
	
	<!-- 批量创建子订单 -->
	<insert id = "insertList" parameterType = "java.util.List">
		insert into drt_shop_order_detail (id,order_id,item_id,item_num,item_earnings,creator_id,create_time)
		values 
		<foreach collection = "list" index = "index" item="drtShopOrder" separator="," >
		(#{drtShopOrder.id},#{drtShopOrder.orderId},#{drtShopOrder.itemId},#{drtShopOrder.itemNum},#{drtShopOrder.itemEarnings},#{drtShopOrder.creatorId},#{drtShopOrder.createTime})
		</foreach>
		
	</insert>
	
	
	<insert id="insert" parameterType="com.csg.intshop.entity.DrtShopOrderDetail" >
    	insert into drt_shop_order_detail
    		(id, order_id, item_id, order_state,  creator_id, creator_name, create_time, modify_id, modify_name, modify_time, item_num, item_earnings, remark, phone, name, postcode) 
    	values
    		(#{id}, #{orderId}, #{itemId}, #{orderState}, #{creatorId}, #{creatorName}, #{createTime}, #{modifyId}, #{modifyName}, #{modifyTime}, #{itemNum}, #{itemEarnings}, #{remark}, #{phone}, #{name}, #{postcode})
  	</insert>

  	<update id="update" parameterType="com.csg.intshop.entity.DrtShopOrderDetail">
		update drt_shop_order_detail set
		modify_time=now()
		<if test="orderId !=null and orderId !=''">
		,order_id=#{orderId}
		</if>
		<if test="itemId !=null and itemId !=''">
		,item_id=#{itemId}
		</if>
		<if test="orderState !=null">
		,order_state=#{orderState}
		</if>
		<if test="createTime != null ">
		, create_time=#{createTime}
		</if>
		<if test="modifyId !=null and modifyId !=''">
		, modify_id=#{modifyId}
		</if>
		<if test="modifyName !=null and modifyName !=''">
		, modify_name=#{modifyName}
		</if>
		<if test="itemNum !=null">
		, item_num=#{itemNum}
		</if>
		<if test = "itemEarnings !=null ">
		, item_earnings=#{itemEarnings}
		</if>
		<if test = "remark !=null and remark !=''">
		, remark=#{remark}
		</if>
		<if test = "phone !=null and phone !=''">
		, phone=#{phone}
		</if>
		<if test = "name !=null and name !=''">
		, name=#{name}
		</if>
		<if test = "postcode !=null and postcode !=''">
		, postcode=#{postcode}
		</if>
		
		where 1= 1 
		<if test = "id !=null and id !=''">
		and id = #{id}
		</if>
		<if test = "itemId !=null and itemId !=''">
		and item_id = #{itemId}
		</if>
		<if test = "orderId !=null and orderId !=''">
		and order_id = #{orderId}
		</if>
	</update>

	<select id="selectByPrimaryKey" resultMap="BaseResultMap" parameterType="java.lang.String" >
	    select 
	    <include refid="BaseColumnList" />
	    from drt_shop_order_detail
	    where 
			id = #{id}
  	</select>

  	<select id="selectList" resultMap="BaseResultMap" parameterType="com.csg.intshop.entity.DrtShopOrderDetail">
	    select 
	    <include refid="BaseColumnList" />
	    from drt_shop_order_detail
	    where 1=1
	    <include refid="BaseCustomQueryCondition" />
  	</select>


    <resultMap id="OrderResultMap" type="com.csg.intshop.entity.DrtShopOrderDetail">
        <id column="id" property="id"></id>
		<result column="order_id" property="orderId" />
		<result column="item_id" property="itemId" />
		<result column="item_num" property="itemNum" />
		<result column="create_time" property="createTime" />
		<result column="item_earnings" property="itemEarnings" />
		<association property="drtShopItem" javaType="com.csg.intshop.entity.DrtShopItem" column="id">
			<id column="itemId" property="id"></id>
			<result column="item_name" property="itemName" />
			<result column="item_price" property="itemPrice" />
			<result column="item_earnings" property="itemEarnings" />
			<result column="item_text" property="itemText" />
			<result column="item_picture" property="itemPicture" />
 		</association>
	</resultMap>
  

    <!-- 获取用户所有订单 -->
   <select id="selectListByOrderID" resultMap="OrderResultMap" parameterType="java.util.Map">
	  SELECT
	        c.id id,
			c.order_id,
			b.item_name,
			b.id itemId,
			b.item_price,
			b.item_text,
		    b.item_picture,
		    b.item_earnings*0.01 item_earnings,
		    c.item_num,
		    c.item_earnings*0.01 item_earnings,
		    c.create_time
		FROM
			drt_shop_item b,
			drt_shop_order_detail c
		WHERE
		    c.item_id = b.id
		<if test="orderIds!=null and  orderIds.size!=0">
         	AND c.order_id in
	         <foreach item="item" collection="orderIds" index="index" open="(" separator="," close=")" >  
		        #{item}
		    </foreach>
         </if>
  	</select>

	
</mapper>