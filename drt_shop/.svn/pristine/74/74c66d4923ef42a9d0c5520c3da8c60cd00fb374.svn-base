<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=0">
    <title>订单详情</title>
    <link rel="stylesheet" type="text/css" href="../../css/weui.css" />
    <link rel="stylesheet" type="text/css" href="../../css/public.css" />
    <link rel="stylesheet" type="text/css" href="../../css/mall.css" />
    <style type="text/css">
    .weui-cell__hd label{
        float:left;
    }
    .weui-cell__bd{
        display:none;
    }
    </style>
</head>
<body style="background:#f6f6f6;">
    <div class="container">
        <div class="head">
            <div class="head_navbar"  style = "background-color: #184f84;color:white">
                <div class="head_navbar_left">
                    <a class="w-h-35" href="javascript:;" onClick="javascript :history.back(-1);"><i class="back_before"></i></a>
                </div>
                <div class="head_navbar_item"><span style = "text-align:center;margin-left:30%;">订单详情</span>
                	<input type = "button" value = "商城" onclick = "goToMall()" style = "background-color: #184f84;color:white;margin-left:20%">
                </div>
               <!--  <div class="head_navbar_item" id = "orderItem">订单详情</div> -->
            </div>
        </div>
        <div class="look_title" style="display:none" id="logindiv"> 
            <i></i>
            <span id="info"></span>
        </div>
        <div id="shopid">
		        <div class="order_state_wrap">
		            <div class="order_state" style="border-top:0;">
		                	<span class="order_num" id = "orderNum"></span>
		            </div>
		            	<!-- 购买商品展示区 -->
		            <div id = "shopGoodsDetail">
		            
		            </div>
		        </div>
		        <div class="rec_info">
		            <div class="rec_info_title clear">
		                <div class="tit_f_l">收货信息</div>
		                <div class="tit_f_r" onclick = "updatePosition()">
		                    <i><img src="../../css/img/editor.png" height="14" alt="" /></i>
		                    编辑地址
		                </div>
		            </div>
		            <div class="weui-cells weui-cells_form">
		                <div class="weui-cell pad_15">
		                    <div class="weui-cell__hd">
		                        <label class="weui-label">收货人：</label>
		                        <label id = "name"></label>
		                    </div>
		                    <div class="weui-cell__bd">
		                        <input class="weui-input" type="text" placeholder="">
		                    </div>
		                </div>
		                <div class="weui-cell pad_15">
		                    <div class="weui-cell__hd">
		                        <label class="weui-label">联系电话 :</label>
		                        <label id = "phone"></label>
		                    </div>
		                    <div class="weui-cell__bd">
		                        <input class="weui-input" type="number" >
		                    </div>
		                </div>
		                <div class="weui-cell pad_15">
		                    <div class="weui-cell__hd">
		                        <label class="weui-label">收货地址 :</label>
		                        <label id = "address_other"></label>
		                    </div>
		                    <div class="weui-cell__bd">
		                        <input class="weui-input" type="text" >
		                    </div>
		                </div>
		            </div>
		        </div>
		        <div style="height:80px;"></div>
		        <div class="set_acc clear">
		            <div class="set_acc_l">
		                合计：<span><span class="num" id = "totalMoney"></span> 积分</span>
		            </div>
		            <span onclick = "exchangeGoods()" class="set_acc_r">兑换</span>
		        </div>
		</div>
    </div>
    <script type="text/javascript" src="../../js/jquery.min.js"></script>
    <script type="text/javascript" src="../../common/common.js"></script>
    <script type="text/javascript">
         $(function(){
        	getGoodsId();
         });
         
	/*********查询收货地址 ************/
	function queryPosition(){
		var url = getRootPath()+"/ins/drtShopAddress/queryAddressList";
    	var params = {};
    	params.isDefault = 0;
    	$.ajax({
	         type: "post",
	         url: url,
	         data: params,
	         success: function(result){
	        	 if(result=="-1"){
 	     			$("#shopid").hide();
 	     			$("#logindiv").show();
 	     			$("#info").html("请登录！");
 	     			return;
 	     		}
				 if(result.state == 0){
					 setPositionInfo(result.data);
				 }
	         }
	     });
	}
	/*****设置地址信息 *******/
    function setPositionInfo(result){
    	for(var i = 0 ;i< result.length;i++){
	    	$("#name").html(result[i].name);
	    	$("#phone").html(result[i].phone);
	    	$("#address_other").html(result[i].addressLevel1+result[i].addressLevel2+result[i].addressLevel3+result[i].addressOther);
    	}
    }
         
         /**增加数量 */
         function addNum(btn,id){
        	 var price = parseInt(btn.nextElementSibling.innerHTML);
        	 var n =  parseInt(btn.nextElementSibling.nextElementSibling.innerHTML);
             n++;
             btn.nextElementSibling.nextElementSibling.innerHTML = n;
             
             var totalMoney = parseInt($("#totalMoney").html());
             $("#totalMoney").html(totalMoney+price);
             changeNumEarnings(id,n,totalMoney+price);
         }
         
         /**减少数量  */
         function reduceNum(btn,id){
        	 var price = parseInt(btn.previousElementSibling.previousElementSibling.innerHTML);
        	 var n = parseInt(btn.previousElementSibling.innerHTML);
             n--;
             if(n<1){
                 n=1;
             }else{
            	 var totalMoney = parseInt($("#totalMoney").html());
                 $("#totalMoney").html(totalMoney-price);
             }
             btn.previousElementSibling.innerHTML = n;
             changeNumEarnings(id,n,totalMoney-price);
         }
         
         /******改变订单中中 商品数量 以及积分值 *******/
     	function changeNumEarnings(id,itemNum,earnings){
     		var url = getRootPath()+"/ins/drtShopOrderDetail/changeNumEarnings";
     		var params = {};
     		params.itemId = id
     		params.itemNum = itemNum;
     		params.earnings = earnings;
     		params.orderId = orderId;
     		 $.ajax({
     	         type: "post",
     	         url: url,
     	         data: params,
     	         success: function(result){
     	         }
     	     });
     	}
         
         /*获取订单id     */
       function getGoodsId(){
        	 var str = location.search;
        	 var id = str.split('=')[1];
        	 if(str.search("orderState")!=-1){//1表示订单是代付款状态 
        		 queryOrderGoods(id.split("&")[0]);
        	 }
         }
         
      
        /*发送请求，到数据库查找产品信息 */
        var orderId = null;
    	function queryOrderGoods(id){
    		orderId = id;
    		var url = getRootPath()+"/ins/drtShopOrder/queryGoods";
    		var params = {};
    		params.orderId = id;
    		 $.ajax({
    	         type: "post",
    	         url: url,
    	         data: params,
    	         success: function(result){
    				 if(result.state == 0){
    					setOrderGoods(result.data);
 					 }
    	         }
    	     });
    	}
         
       /**显示订单中的商品 */
       var totalMoney = 0;
       function setOrderGoods(result){    
    	   $("#orderNum").html("订单号:"+result[0].orderNo);
    	   $("#name").html(result[0].name);
	    	$("#phone").html(result[0].phone);
	    	$("#address_other").html(result[0].addressOther);
    	   var shopGoodsDetail = $("#shopGoodsDetail");
    	   shopGoodsDetail.empty();
    	   for(var i = 0 ;i < result.length; i ++){
    		   var panel = '<div class="shop_goods_item clear"> '+
	               ' <div class="detail clear"> '+
	                   ' <div class="goods_pic">'+
	                    '    <img src="'+getRootPath()+result[i].itemPicture+'" width="100%" alt="" />'+
	                    '</div>'+
	                    ' <span  style = "display:none">'+result[i].itemId+'</span> '+
	                    '<div class="goods_con" onclick="goToGoodsDetail(this)">'+
	                     '   <p class="tit order_title" id = "idTitle">'+result[i].itemName+'</p>'+
	                      '  <div class="price clear">'+
	                       '     <p class="rmb"><span class="rmb_num" id = "needPoints">'+result[i].itemEarnings/100+'</span></p>'+
	                        '</div>'+
	                    '</div>'+
	                '</div>'+
	                '<div class="chos_num clear" value = "'+result[i].itemEarnings/100+'">'+
	                '<span style="border:1px solid #dedede" onclick = "addNum(this,'+result[i].itemId+')">+</span>'+
	                ' <span  style = "display:none">'+result[i].itemEarnings/100+'</span> '+
	                '<span class = "exch_num" style="border:1px solid #dedede">'+result[i].itemNum+'</span>'+
	                '<span style="border:1px solid #dedede" onclick = "reduceNum(this,'+result[i].itemId+')">-</span>'+
	                '</div>'+
	            '</div>';
	            totalMoney = totalMoney+parseInt(result[i].itemEarnings/100)*parseInt(result[i].itemNum);
    		   shopGoodsDetail.append(panel);
    	   }
    	   $("#totalMoney").html(totalMoney);
       }
       /***跳转***/
       function goToGoodsDetail(btn){
    	   var id = btn.previousElementSibling.innerHTML;
    	   return location.href="goods_detail.html?id="+id;
       }
       
       /**校验地址是否为空 */
       function checkAddress(){
    	   var name = $("#name").html().trim();
    	   if(name==null||name==""){
    		   Toast("收货人姓名不能为空",2000);
    		   return false;
    	   }
	       var phone = $("#phone").html().trim();
	       if(phone == null&&phone==""){
	    	   Toast("收货人联系方式不能为空",2000);
	    	   return false;
	       }
	       var addressOther = $("#address_other").html().trim();
	       if(addressOther == null&&addressOther==""){
	    	   Toast("收货人详细地址不能为空",2000);
	    	   return false;
	       }
	       return true;
       }
       
       /*兑换商品 **/
       function exchangeGoods(){
    	   var checkRegx = checkAddress();
    	   if(!checkRegx){
    		   return;
    	   }
    	   var totalMoney = parseInt($("#totalMoney").html());
    	   var orderNo =  $("#orderNum").html().split(":")[1];
    	   return location.href='payment.html?totalMoney='+totalMoney+'&'+orderId+'&'+orderNo;
       }
       
       /****编辑地址 *********/
       function updatePosition(){
    	   return location.href="../addressList.html?orderId="+orderId+"&";
       }
       
       /**返回首页 **/
   		function goToMall(){
    	   return location.href="../mall_index.html";
       }
    </script>
</body>
</html>